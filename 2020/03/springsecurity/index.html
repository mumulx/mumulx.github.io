<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        SpringSecurity自学笔记 - 木木的个人博客
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="SpringSecurity的学习记录." />
  <meta name="generator" content="Hugo 0.59.1 with theme pure" />
  <title>SpringSecurity自学笔记 - 木木的个人博客</title>
  

  <link rel="stylesheet" href="https://mumulx.github.io/css/style.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css"> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <meta property="og:title" content="SpringSecurity自学笔记" />
<meta property="og:description" content="SpringSecurity的学习记录." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mumulx.github.io/2020/03/springsecurity/" />
<meta property="article:published_time" content="2020-03-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-03-06T00:00:00+00:00" />

<meta itemprop="name" content="SpringSecurity自学笔记">
<meta itemprop="description" content="SpringSecurity的学习记录.">


<meta itemprop="datePublished" content="2020-03-06T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-03-06T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="15807">



<meta itemprop="keywords" content="Spring家族," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SpringSecurity自学笔记"/>
<meta name="twitter:description" content="SpringSecurity的学习记录."/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>
  

  <body class="main-center" itemscope itemtype="https://schema.org/WebPage"><header class="header" itemscope itemtype="https://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/mumulx" target="_blank">
            <img class="img-circle img-rotate" src="https://mumulx.github.io/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">木木就是两个木</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">木木</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>xuzhou, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="想要查找什么..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="https://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>
  <aside class="sidebar" itemscope itemtype="https://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>我们的征途是星辰大海！</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> 分类</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://mumulx.github.io/categories/%E6%8A%80%E6%9C%AF%E6%94%B6%E5%BD%95/" class="category-list-link">技术收录</a><span class="category-list-count">21</span></li>
            <li class="category-list-item"><a href="https://mumulx.github.io/categories/%E6%8A%80%E6%9C%AF%E6%A1%86%E6%9E%B6/" class="category-list-link">技术框架</a><span class="category-list-count">13</span></li>
            <li class="category-list-item"><a href="https://mumulx.github.io/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" class="category-list-link">杂七杂八</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://mumulx.github.io/categories/%E7%A7%81%E4%BA%BA%E5%8D%9A%E5%AE%A2/" class="category-list-link">私人博客</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://mumulx.github.io/categories/%E9%97%AE%E9%A2%98%E6%94%B6%E5%BD%95/" class="category-list-link">问题收录</a><span class="category-list-count">2</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> 标签</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/j2ee/" class="tag-list-link">j2ee</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/java/" class="tag-list-link">java</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="tag-list-link">java并发编程</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/linux/" class="tag-list-link">linux</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/node/" class="tag-list-link">node</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/spring%E5%AE%B6%E6%97%8F/" class="tag-list-link">spring家族</a><span
                    class="tag-list-count">12</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="tag-list-link">中间件</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E5%85%B6%E4%BB%96%E9%97%AE%E9%A2%98/" class="tag-list-link">其他问题</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" class="tag-list-link">前端框架</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E5%BC%80%E5%8F%91%E8%BD%AF%E4%BB%B6/" class="tag-list-link">开发软件</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="tag-list-link">数据库</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E6%97%A5%E8%AE%B0/" class="tag-list-link">日记</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" class="tag-list-link">杂七杂八</a><span
                    class="tag-list-count">7</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.github.io/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/" class="tag-list-link">版本控制</a><span
                    class="tag-list-count">2</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.github.io/2020/04/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="title">Java并发编程</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-04-25</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.github.io/2020/04/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%8E%9F%E7%90%86%E7%AF%87/" class="title">Java并发编程原理篇</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-04-25</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.github.io/2020/04/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%BA%94%E7%94%A8%E7%AF%87/" class="title">Java并发编程应用篇</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-04-25</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.github.io/2020/04/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E6%A8%A1%E5%BC%8F%E7%AF%87/" class="title">Java并发编程模式篇</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-04-25 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-04-25</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.github.io/2020/03/nginx%E7%AC%94%E8%AE%B0/" class="title">Nginx进阶学习笔记</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2020-03-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-03-07</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
  <aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="https://schema.org/WPSideBar">
    <div class="slimContent">
      <nav id="toc" class="article-toc">
        <h3 class="toc-title">文章目录</h3>
        <div class="toc-content always-active"><nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#springsecurity">SpringSecurity</a>
<ul>
<li><a href="#需求分析与环境准备">需求分析与环境准备</a></li>
<li><a href="#h-ttpbasic模式登录认证">H TTPBASIC模式登录认证</a></li>
<li><a href="#formlogin表单登录认证模式">FORMLOGIN表单登录认证模式</a>
<ul>
<li><a href="#登录认证流程源码解析">登录认证流程源码解析</a></li>
<li><a href="#自定义登录验证结果处理">自定义登录验证结果处理</a></li>
</ul></li>
<li><a href="#session管理及安全">SESSION管理及安全</a>
<ul>
<li><a href="#会话超时配置">会话超时配置</a></li>
<li><a href="#session保护">session保护</a></li>
<li><a href="#cookie的安全">Cookie的安全</a></li>
<li><a href="#限制最大登录用户数量">限制最大登录用户数量</a></li>
</ul></li>
<li><a href="#rbac权限管理模型">RBAC权限管理模型</a></li>
<li><a href="#动态加载数据库数据进行认证与授权">动态加载数据库数据进行认证与授权</a></li>
<li><a href="#动态加载资源鉴权规则">动态加载资源鉴权规则</a></li>
<li><a href="#权限表达式的使用方法">权限表达式的使用方法</a>
<ul>
<li><a href="#权限表达式在全局配置中的使用">权限表达式在全局配置中的使用</a></li>
<li><a href="#方法级别的安全控制">方法级别的安全控制</a></li>
</ul></li>
<li><a href="#rememberme记住密码">REMEMBERME记住密码</a>
<ul>
<li><a href="#使用数据库实现remember">使用数据库实现remember</a></li>
</ul></li>
<li><a href="#用户退出功能的实现">用户退出功能的实现</a>
<ul>
<li><a href="#个性化配置">个性化配置</a></li>
<li><a href="#logoutsuccesshlandler">LogoutSuccesshlandler</a></li>
</ul></li>
<li><a href="#图片验证码的实现方案">图片验证码的实现方案</a>
<ul>
<li><a href="#session存储验证码">session存储验证码</a></li>
<li><a href="#验证码验证">验证码验证</a></li>
<li><a href="#共享session存储验证码">共享session存储验证码</a></li>
<li><a href="#基于对称算法的验证码">基于对称算法的验证码</a></li>
</ul></li>
<li><a href="#短信验证码登录功能">短信验证码登录功能</a>
<ul>
<li><a href="#获取短信验证码">获取短信验证码</a></li>
<li><a href="#短信验证码校验过滤器">短信验证码校验过滤器</a></li>
<li><a href="#短信验证码登录认证过滤器">短信验证码登录认证过滤器</a></li>
<li><a href="#综合配置">综合配置</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
        </div>
      </nav>
    </div>
  </aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="https://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2020/03/springsecurity/"
    >SpringSecurity自学笔记</a
  >
</h1>

      <div class="article-meta">
        <span class="article-date">
  <i class="icon icon-calendar-check"></i>
<a href="https://mumulx.github.io/2020/03/springsecurity/" class="article-date">
  <time datetime="2020-03-06 00:00:00 &#43;0000 UTC" itemprop="datePublished">2020-03-06</time>
</a>
</span><span class="article-category">
  <i class="icon icon-folder"></i>
  <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%A1%86%E6%9E%B6/"> 技术框架 </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>
    <a class="article-tag-link" href="/tags/spring%E5%AE%B6%E6%97%8F/"> Spring家族 </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/03/springsecurity/#comments"
            class="article-comment-link">评论</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计:15807字</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长:32分 </span>
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      

<h2 id="springsecurity">SpringSecurity</h2>

<p><a href="https://spring.io/projects/spring-security">官网:</a></p>

<p>SpringSecurity是强大的，且容易定制的实现认证，与授权的基于Spring 开发的框架。</p>

<p>Spring Security的核心功能</p>

<ul>
<li>Authentication:认证，用户登陆的验证(解决你是谁的问题)</li>
<li>Authorization: 授权，授权资源的访问权限(解决你能干什么的问题)</li>
<li>安全防护，防止跨站请求，session 攻击等</li>
</ul>

<p><strong>springsecurity与shiro</strong></p>

<ul>
<li>使用的方便度(shiro)</li>
<li>社区支持比较(几乎持平)</li>
<li>功能丰富性(spring security)</li>
</ul>

<p>如果你只是想实现一个简单的web应用，shiro更 加的轻量级，学习成本也更低。如果您正在开发一个分布式的、微服务的、或者与Spring Cloud系列框架深度集成的项目，还是建议使用Spring Security。</p>

<h3 id="需求分析与环境准备">需求分析与环境准备</h3>

<ul>
<li>login.html登录页面，登录页面访问不受限制</li>
<li>在登录页面登录之后，进入index.html首页(登录验证Authentication)</li>
<li>首页可以看到syslog、sysuer. biz1. biz2四个页面选项</li>
<li>我们希望syslog (日志管理)和sysuser(用户管理)只有admin管理员可以访问(权限管理Authorization)</li>
<li>biz1、 biz2普通的操作用户auser就可以访问(权限管理Authorization)</li>
</ul>

<p>起一个新的spring boot2.0版本的web应用</p>

<p>集成mybatis、lombok</p>

<p>搭建</p>

<p>添加依赖</p>

<pre><code class="language-xml">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>

<p>配置</p>

<p>新建配置类SecurityConfig</p>

<pre><code class="language-java">@Configuration
public class SecurityConfig  extends WebSecurityConfigurerAdapter {
 @Override
 protected void configure(HttpSecurity http) throws Exception {
	 http.httpBasic()
 	.and()
	 .authorizeRequests().anyRequest()
 	.authenticated();
	}
}
</code></pre>

<p>这样启动后访问</p>

<pre><code>http://localhost:8888/login.html
</code></pre>

<p>会让我们输入用户名密码</p>

<p>用户名：user</p>

<p>密码在控制台</p>

<p>想要自定义密码</p>

<p>添加配置，在spring下</p>

<pre><code>  security:
    user:
      name: admin
      password: admin
</code></pre>

<h3 id="h-ttpbasic模式登录认证">H TTPBASIC模式登录认证</h3>

<p>使用postman模拟访问</p>

<p>新建get请求</p>

<pre><code>http://localhost:8888/index
</code></pre>

<p>Authorization</p>

<p>Type：Basic Auth</p>

<p>username：admin</p>

<p>password：admin</p>

<p>查看相应，可以看到我们的html代码</p>

<p>观察headers</p>

<p>Authorization：YWRtaW46YWRtaW4=</p>

<p>搜索base64加密解密</p>

<p>YWRtaW46YWRtaW4=</p>

<p>可以解密密码</p>

<p>admin:admin</p>

<p>这种方式时不安全的</p>

<h3 id="formlogin表单登录认证模式">FORMLOGIN表单登录认证模式</h3>

<p>三要素</p>

<ul>
<li>登录认证逻辑(静态)</li>
<li>资源访问控制(动态)</li>
<li>用户角色权限(动态)</li>
</ul>

<p>认证的方式有两种：权限、角色</p>

<p>二者都可是实现</p>

<p>配置类SecurityConfig</p>

<pre><code class="language-java">@Configuration
public class SecurityConfig  extends WebSecurityConfigurerAdapter {
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.csrf().disable()//关掉csrf，否则会将我们的请求当作是一个不合法的
            .formLogin()
                //逻辑
                .loginPage(&quot;/login.html&quot;)//登陆页面位置
                .usernameParameter(&quot;username&quot;)//表单用户名name
                .passwordParameter(&quot;password&quot;)//表单密码name
                .loginProcessingUrl(&quot;/login&quot;)//  登录验证请求  post方式的表单action
                .defaultSuccessUrl(&quot;/index&quot;)//成功后的跳转页面
           		.failureUrl(&quot;/login.html&quot;)
                .and()
                //控制
                .authorizeRequests()
                    .antMatchers(&quot;/login.html&quot;,&quot;login&quot;).permitAll()//哪些请求不需要验证
                    .antMatchers(&quot;/biz1&quot;,&quot;/biz2&quot;)//需要对外暴漏的资源的路径，user用户和admin用户可以访问
                        .hasAnyAuthority(&quot;ROLE_user&quot;,&quot;ROLE_admin&quot;)//user用户和admin用户  权限
                    .antMatchers(&quot;/syslog&quot;,&quot;/sususer&quot;)
          	  // .antMatchers(&quot;/syslog&quot;).hasAuthority(&quot;sys:log&quot;)//通过权限进行配置
				//.antMatchers(&quot;/sysuser&quot;).hasAuthority(&quot;sys:user&quot;)  前面是资源，后面是资源id
                        .hasAnyRole(&quot;admin&quot;)//admin用户可以访问 .hasAnyAuthority(&quot;ROLE_admin&quot;)，另一种写法  角色
                    .anyRequest().authenticated()
        ;
    }
    //静态配置了两个用户
    @Override
    public void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
                .withUser(&quot;user&quot;)//用户user
                .password(passwordEncoder().encode(&quot;123456&quot;))//密码
                .roles(&quot;user&quot;)//角色
                    .and()
                .withUser(&quot;admin&quot;)//用户
                .password(passwordEncoder().encode(&quot;123456&quot;))//密码
//.authorities(&quot;sys:log&quot;,&quot;sys:user&quot;)权限  当用户有这个资源的id就可以访问这个资源，用户没有这个资源的id就不能访问这个资源
                .roles(&quot;admin&quot;)//角色
                    .and()
                .passwordEncoder(passwordEncoder());//配置BCrypt加密
    }
    @Bean
    public PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }
        @Override
    public void configure(WebSecurity web) {
        //将项目中静态资源路径开放出来
        web.ignoring()
                .antMatchers( &quot;/css/**&quot;, &quot;/fonts/**&quot;, &quot;/img/**&quot;, &quot;/js/**&quot;);
    }

}
</code></pre>

<pre><code class="language-html">&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
    &lt;span&gt;用户名称&lt;/span&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot; /&gt; &lt;br&gt;
    &lt;span&gt;用户密码&lt;/span&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; /&gt; &lt;br&gt;
    &lt;input type=&quot;submit&quot; value=&quot;登陆&quot;&gt;
&lt;/form&gt;
</code></pre>

<p>通过以下与表单进行绑定，表单的请求方式必须是post</p>

<pre><code class="language-java">.usernameParameter(&quot;username&quot;)//表单用户名name
.passwordParameter(&quot;password&quot;)//表单密码name
.loginProcessingUrl(&quot;/login&quot;)//  登录验证请求  post方式的表单action
</code></pre>

<p>不需要我们进行登录用户名和密码的校验，springsecurity在我们请求时，自动帮我们进行认证处理</p>

<p>测试</p>

<p>访问</p>

<pre><code>http://localhost:8888/login.html
</code></pre>

<p>使用admin:admin进行登录，发现是可以全部访问的</p>

<p>切换用户，user:123456</p>

<p>只能访问业务一、业务二</p>

<h4 id="登录认证流程源码解析">登录认证流程源码解析</h4>

<p><img src="/resources/技术框架/Spring家族/14483918-baacf316904e06b7.png" alt="登录认证流程源码解析" /></p>

<pre><code class="language-java">public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
   //定义了默认的用户名密码name
   public static final String SPRING_SECURITY_FORM_USERNAME_KEY = &quot;username&quot;;
    public static final String SPRING_SECURITY_FORM_PASSWORD_KEY = &quot;password&quot;;
    private String usernameParameter = &quot;username&quot;;
    private String passwordParameter = &quot;password&quot;;
    private boolean postOnly = true;

    public UsernamePasswordAuthenticationFilter() {
        super(new AntPathRequestMatcher(&quot;/login&quot;, &quot;POST&quot;));
    }

    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
    //指定请求为post请求
        if (this.postOnly &amp;&amp; !request.getMethod().equals(&quot;POST&quot;)) {
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        } else {
            String username = this.obtainUsername(request);
            String password = this.obtainPassword(request);
            if (username == null) {
                username = &quot;&quot;;
            }

            if (password == null) {
                password = &quot;&quot;;
            }
            username = username.trim();
            //构建了一个登录令牌，通过用户名密码
            UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
            this.setDetails(request, authRequest);
            //返回一个登录认证的主体对象，贯穿过滤器，对它进行登录认证
            return this.getAuthenticationManager().authenticate(authRequest);
        }
    }

</code></pre>

<pre><code class="language-java">public interface AuthenticationManager {
    //该方法进行认证
    Authentication authenticate(Authentication var1) throws AuthenticationException;
}

</code></pre>

<pre><code class="language-java">//实现了AuthenticationManager接口
public class ProviderManager implements AuthenticationManager, MessageSourceAware, InitializingBean {
      //存储了很多登录认证的实例 
    private List&lt;AuthenticationProvider&gt; providers;
</code></pre>

<pre><code>AuthenticationProvider是一个接口，很多登录认证的方式实现了该接口
</code></pre>

<pre><code>DaoAuthenticationProvider//从数据库加载信息
//加载信息
UserDetails loadedUser = this.getUserDetailsService().loadUserByUsername(username);
</code></pre>

<p>过滤器</p>

<pre><code>public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
</code></pre>

<pre><code class="language-java">public abstract class AbstractAuthenticationProcessingFilter extends GenericFilterBean implements ApplicationEventPublisherAware, MessageSourceAware {
//成功
    private AuthenticationSuccessHandler successHandler = new SavedRequestAwareAuthenticationSuccessHandler();
    //失败
    private AuthenticationFailureHandler failureHandler = new SimpleUrlAuthenticationFailureHandler();
</code></pre>

<h4 id="自定义登录验证结果处理">自定义登录验证结果处理</h4>

<pre><code>登陆成功的自定义结果处理接口: AuthenticationSuccesstlandler
登陆失败的自定义结果处理接口: AuthenticationfailureHandler
</code></pre>

<p><strong>AuthenticationSuccesstlandler</strong></p>

<p>配置</p>

<pre><code class="language-java">@Component
public class MyAuthenticationSuccessHandler extends SavedRequestAwareAuthenticationSuccessHandler {
    @Value(&quot;${spring.security.loginType}&quot;)
    private String loginType;
    private static ObjectMapper objectMapper = new ObjectMapper();
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                        HttpServletResponse response,
                                        Authentication authentication)
            throws ServletException, IOException {
        if(loginType.equalsIgnoreCase(&quot;JSON&quot;)){
            response.setContentType(&quot;application/json;charset=UTF-8&quot;);
            response.getWriter().write(objectMapper.writeValueAsString(
                    AjaxResponse.success(&quot;/index&quot;)
            ));
        }else{
            //跳转到登陆之前请求的页面
            super.onAuthenticationSuccess(request,response,authentication);
        }
    }
}

</code></pre>

<p>封装json</p>

<pre><code class="language-java">@Data
public class AjaxResponse {
    private boolean isok;
    private int code;   
    private String message;
    private Object data;
    private AjaxResponse() {
    }
    //请求出现异常时的响应数据封装
    public static AjaxResponse error(CustomException e) {
        AjaxResponse resultBean = new AjaxResponse();
        resultBean.setIsok(false);
        resultBean.setCode(e.getCode());
        if(e.getCode() == CustomExceptionType.USER_INPUT_ERROR.getCode()){
            resultBean.setMessage(e.getMessage());
        }else if(e.getCode() == CustomExceptionType.SYSTEM_ERROR.getCode()){
            resultBean.setMessage(e.getMessage() + &quot;,系统出现异常，请联系管理员电话：1375610xxxx进行处理!&quot;);
        }else{
            resultBean.setMessage(&quot;系统出现未知异常，请联系管理员电话：13756108xxx进行处理!&quot;);
        }
        return resultBean;
    }
    public static AjaxResponse success() {
        AjaxResponse resultBean = new AjaxResponse();
        resultBean.setIsok(true);
        resultBean.setCode(200);
        resultBean.setMessage(&quot;success&quot;);
        return resultBean;
    }
    public static AjaxResponse success(Object data) {
        AjaxResponse resultBean = new AjaxResponse();
        resultBean.setIsok(true);
        resultBean.setCode(200);
        resultBean.setMessage(&quot;success&quot;);
        resultBean.setData(data);
        return resultBean;
    }
}
</code></pre>

<p>添加配置</p>

<pre><code class="language-yml">  security:
    loginType: JSON
</code></pre>

<p>SecurityConfig</p>

<pre><code class="language-java">@Resource
MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;

//.defaultSuccessUrl(&quot;/index&quot;)//成功后的跳转页面
.failureUrl(&quot;/login.html&quot;)
.successHandler(myAuthenticationSuccessHandler)//不能与defaultSuccessUrl一起使用
</code></pre>

<p>测试</p>

<p>访问</p>

<pre><code>http://localhost:8888/syslog
</code></pre>

<p>会自动跳转到login.html</p>

<p>输入用户名密码user:123456</p>

<p>相应</p>

<pre><code>{
isok: true,
code: 200,
message: &quot;success&quot;,
data: &quot;/index&quot;
}
</code></pre>

<p>将json改为html</p>

<pre><code>  security:
    loginType: html
</code></pre>

<p>访问</p>

<pre><code>http://localhost:8888/syslog
</code></pre>

<p>自动跳转到ligin.html</p>

<p>登录用户名密码admin:123456</p>

<p>会直接跳转到</p>

<pre><code>http://localhost:8888/syslog
</code></pre>

<p>会返回上一次的请求路径</p>

<p>配置生效</p>

<pre><code class="language-java">super.onAuthenticationSuccess(request,response,authentication);
</code></pre>

<p><strong>配置登录失败的请求</strong></p>

<p>配置类</p>

<pre><code class="language-java">@Component
public class MyAuthenticationFailureHandler extends SimpleUrlAuthenticationFailureHandler {
    @Value(&quot;${spring.security.loginType}&quot;)
    private String loginType;
    private static ObjectMapper objectMapper = new ObjectMapper();
    public void onAuthenticationFailure(HttpServletRequest request,
                                        HttpServletResponse response,
                                        AuthenticationException exception)
            throws IOException, ServletException {
        String errorMsg = &quot;用户名或者密码输入错误!&quot;;
        if(exception instanceof SessionAuthenticationException){
            errorMsg = exception.getMessage();
        }
        if(loginType.equalsIgnoreCase(&quot;JSON&quot;)){
            response.setContentType(&quot;application/json;charset=UTF-8&quot;);
            response.getWriter().write(objectMapper.writeValueAsString(
                    AjaxResponse.error(new CustomException(
                            CustomExceptionType.USER_INPUT_ERROR,
                            errorMsg))
            ));
        }else{
            //跳转到登陆页面
            super.onAuthenticationFailure(request,response,exception);
        }
    }
}
</code></pre>

<pre><code class="language-java">     //.defaultSuccessUrl(&quot;/index&quot;)//成功后的跳转页面
     //.failureUrl(&quot;/login.html&quot;)
     .successHandler(myAuthenticationSuccessHandler)//不能与defaultSuccessUrl一起使用
     .failureHandler(myAuthenticationFailureHandler)
</code></pre>

<p>更改为JSON方式而不是html方式</p>

<pre><code>  security:
    loginType: JSON
</code></pre>

<p>login.html修改</p>

<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;首页&lt;/title&gt;
    &lt;script src=&quot;https://cdn.staticfile.org/jquery/1.12.3/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;业务系统登录&lt;/h1&gt;
&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
    &lt;span&gt;用户名称&lt;/span&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot;/&gt; &lt;br&gt;
    &lt;span&gt;用户密码&lt;/span&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot;/&gt; &lt;br&gt;
    &lt;input type=&quot;button&quot; onclick=&quot;login()&quot; value=&quot;登陆&quot;&gt;
&lt;/form&gt;
&lt;script&gt;
    function login() {
        var username = $(&quot;#username&quot;).val();
        var password = $(&quot;#password&quot;).val();
        if (username === &quot;&quot; || password === &quot;&quot;) {
            alert('用户名或密码不能为空');
            return;
        }
        $.ajax({
            type: &quot;POST&quot;,
            url: &quot;/login&quot;,
            data: {
                &quot;username&quot;: username,
                &quot;password&quot;: password,
            },
            success: function (json) {
                if(json.isok){
                    location.href = json.data;
                }else{
                    alert(json.message)
                }
            },
            error: function (e) {
                console.log(e.responseText);
            }
        });
    }
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<h3 id="session管理及安全">SESSION管理及安全</h3>

<p>Spring Security与session的创建使用</p>

<ul>
<li>always:如果当前请求没有session存在，Spring Security创建一个session。</li>
<li>never: Spring Security将永远不会主动创建session,但是如果session已经存
在，它将使用该session</li>
<li>ifRequired (默认) :: Spring Security在需要时才创建session</li>
<li>stateless: Spring Security不会创建或使用任何session。适合于接口型的无状态应用，该方式节省资源。</li>
</ul>

<p>配置</p>

<pre><code class="language-java">.and().sessionManagement()
      .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
</code></pre>

<h4 id="会话超时配置">会话超时配置</h4>

<pre><code>server.servlet.session.timeout= 15m  //springboot
spring.session.timeout = 15m	
</code></pre>

<p>配置</p>

<pre><code class="language-yml">server:
  port: 8888
  servlet:
    session:
      timeout: 10s
</code></pre>

<pre><code class="language-java">.sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
                .invalidSessionUrl(&quot;/login/html&quot;)//超时后返回登录页面
</code></pre>

<h4 id="session保护">session保护</h4>

<ul>
<li>默认情况下，Spring Security启用了migrationSession保护方式。即对于同一个cookies的SESSIONID用户，每次登录验证将创建一个新的HTTP会话，旧的HTTP会话将无效，并且旧会话的属性将被复制。</li>
<li>设置为“none”时，原始会话不会无效</li>
<li>设置“newSession”后，将创建一个干净的会话，而不会复制旧会话中的任何属性</li>
</ul>

<p>配置</p>

<pre><code class="language-java">.invalidSessionUrl(&quot;/login/html&quot;)//超时后返回登录页面
                .sessionFixation().migrateSession()//session保护
</code></pre>

<h4 id="cookie的安全">Cookie的安全</h4>

<ul>
<li>httpOnly:如果为true,则浏览器脚本将无法访问cookie</li>
<li>secure:如果为true,则仅通过HTTPS连接发送cookie, HTTP无法携带cookie。</li>
</ul>

<p>配置</p>

<pre><code class="language-yml"> session:
      timeout: 10s
      cookie:
        http-only: true
        secure: false
</code></pre>

<h4 id="限制最大登录用户数量">限制最大登录用户数量</h4>

<p>实现SessionInformationExpiredStrategy接口</p>

<p>配置</p>

<pre><code class="language-java">.sessionFixation().migrateSession()//session保护
    
.maximumSessions(1)
.maxSessionsPreventsLogin(false)//true:登录之后不能再登录，false：允许再次登录，但是前一次登录会下线
.expiredSessionStrategy(new MyExpiredSessionStrategy())//超时session响应策略
</code></pre>

<p>实现接口</p>

<pre><code class="language-java">public class MyExpiredSessionStrategy implements SessionInformationExpiredStrategy {
    private static ObjectMapper objectMapper = new ObjectMapper();
    //session超时后会调用
    @Override
    public void onExpiredSessionDetected(SessionInformationExpiredEvent event) throws IOException, ServletException {
        Map&lt;String,Object&gt; map  = new HashMap&lt;&gt;();
        map.put(&quot;code&quot;,0);
        map.put(&quot;msg&quot;,&quot;您已经在另外一台电脑或浏览器登录，被迫下线！&quot;);
        event.getResponse().setContentType(&quot;application/json;charset=UTF-8&quot;);
        event.getResponse().getWriter().write(
                objectMapper.writeValueAsString(map)
        );
    }
}
</code></pre>

<p>两个浏览器登录同一个用户，第一个用户会显示</p>

<pre><code class="language-json">{
msg: &quot;您已经在另外一台电脑或浏览器登录，被迫下线！&quot;,
code: 0
}
</code></pre>

<h3 id="rbac权限管理模型">RBAC权限管理模型</h3>

<p>Role-Based Access Control</p>

<ul>
<li>用户:系统接口及访问的操作者</li>
<li>权限:能够访问某接口或者做某操作的授权资格</li>
<li>角色:具有一类相同操作权限的用户的总称</li>
</ul>

<p>用户-一对多-&gt;角色-多对多-&gt;权限</p>

<p>创建表格</p>

<pre><code class="language-sql">-- 导出  表 devicedb.sys_menu 结构
CREATE TABLE IF NOT EXISTS `sys_menu` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `menu_pid` int(11) NOT NULL COMMENT '父菜单ID',
  `menu_pids` varchar(64) NOT NULL COMMENT '当前菜单所有父菜单',
  `is_leaf` tinyint(4) NOT NULL COMMENT '0:不是叶子节点，1:是叶子节点',
  `menu_name` varchar(16) NOT NULL COMMENT '菜单名称',
  `url` varchar(64) DEFAULT NULL COMMENT '跳转URL',
  `icon` varchar(45) DEFAULT NULL,
  `icon_color` varchar(16) DEFAULT NULL,
  `sort` tinyint(4) DEFAULT NULL COMMENT '排序',
  `level` tinyint(4) NOT NULL COMMENT '菜单层级',
  `status` tinyint(4) NOT NULL COMMENT '0:启用,1:禁用',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8 COMMENT='系统菜单表';
-- 正在导出表  devicedb.sys_menu 的数据：~5 rows (大约)
/*!40000 ALTER TABLE `sys_menu` DISABLE KEYS */;
INSERT INTO `sys_menu` (`id`, `menu_pid`, `menu_pids`, `is_leaf`, `menu_name`, `url`, `icon`, `icon_color`, `sort`, `level`, `status`) VALUES
	(1, 0, '0', 0, '系统管理', NULL, NULL, NULL, 1, 1, 0),
	(2, 1, '1', 1, '用户管理', '/sysuser', NULL, NULL, 1, 2, 0),
	(3, 1, '1', 1, '日志管理', '/syslog', NULL, NULL, 2, 2, 0),
	(4, 1, '1', 1, '业务一', '/biz1', NULL, NULL, 3, 2, 0),
	(5, 1, '1', 1, '业务二', '/biz2', NULL, NULL, 4, 2, 0);
/*!40000 ALTER TABLE `sys_menu` ENABLE KEYS */;
-- 导出  表 devicedb.sys_org 结构
CREATE TABLE IF NOT EXISTS `sys_org` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `org_pid` int(11) NOT NULL COMMENT '上级组织编码',
  `org_pids` varchar(64) NOT NULL COMMENT '所有的父节点id',
  `is_leaf` tinyint(4) NOT NULL COMMENT '0:不是叶子节点，1:是叶子节点',
  `org_name` varchar(32) NOT NULL COMMENT '组织名',
  `address` varchar(64) DEFAULT NULL COMMENT '地址',
  `phone` varchar(13) DEFAULT NULL COMMENT '电话',
  `email` varchar(32) DEFAULT NULL COMMENT '邮件',
  `sort` tinyint(4) DEFAULT NULL COMMENT '排序',
  `level` tinyint(4) NOT NULL COMMENT '组织层级',
  `status` tinyint(4) NOT NULL COMMENT '0:启用,1:禁用',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 COMMENT='系统组织结构表';
-- 正在导出表  devicedb.sys_org 的数据：~4 rows (大约)
/*!40000 ALTER TABLE `sys_org` DISABLE KEYS */;
INSERT INTO `sys_org` (`id`, `org_pid`, `org_pids`, `is_leaf`, `org_name`, `address`, `phone`, `email`, `sort`, `level`, `status`) VALUES
	(1, 0, '0', 0, '总部', NULL, NULL, NULL, 1, 1, 0),
	(2, 1, '1', 0, '研发部', NULL, NULL, NULL, 1, 2, 0),
	(3, 2, '1,2', 1, '研发一部', NULL, NULL, NULL, 1, 3, 0),
	(4, 2, '1,2', 1, '研发二部', NULL, NULL, NULL, 2, 3, 0);
/*!40000 ALTER TABLE `sys_org` ENABLE KEYS */;
-- 导出  表 devicedb.sys_role 结构
CREATE TABLE IF NOT EXISTS `sys_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `role_name` varchar(32) NOT NULL DEFAULT '0' COMMENT '角色名称(汉字)',
  `role_desc` varchar(128) NOT NULL DEFAULT '0' COMMENT '角色描述',
  `role_code` varchar(32) NOT NULL DEFAULT '0' COMMENT '角色的英文code.如：ADMIN',
  `sort` int(11) NOT NULL DEFAULT '0' COMMENT '角色顺序',
  `status` int(11) DEFAULT NULL COMMENT '0表示可用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '角色的创建日期',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COMMENT='系统角色表';
-- 正在导出表  devicedb.sys_role 的数据：~2 rows (大约)
/*!40000 ALTER TABLE `sys_role` DISABLE KEYS */;
INSERT INTO `sys_role` (`id`, `role_name`, `role_desc`, `role_code`, `sort`, `status`, `create_time`) VALUES
	(1, '管理员', '管理员', 'admin', 1, 0, '2019-12-23 22:56:48'),
	(2, '普通用户', '普通用户', 'common', 2, 0, '2019-12-23 22:57:22');
/*!40000 ALTER TABLE `sys_role` ENABLE KEYS */;
-- 导出  表 devicedb.sys_role_menu 结构
CREATE TABLE IF NOT EXISTS `sys_role_menu` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `role_id` int(11) NOT NULL DEFAULT '0' COMMENT '角色id',
  `menu_id` int(11) NOT NULL DEFAULT '0' COMMENT '权限id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8 COMMENT='角色权限关系表';
-- 正在导出表  devicedb.sys_role_menu 的数据：~4 rows (大约)
/*!40000 ALTER TABLE `sys_role_menu` DISABLE KEYS */;
INSERT INTO `sys_role_menu` (`id`, `role_id`, `menu_id`) VALUES
	(1, 1, 2),
	(2, 1, 3),
	(3, 2, 4),
	(4, 2, 5);
/*!40000 ALTER TABLE `sys_role_menu` ENABLE KEYS */;
-- 导出  表 devicedb.sys_user 结构
CREATE TABLE IF NOT EXISTS `sys_user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(64) NOT NULL DEFAULT '0' COMMENT '用户名',
  `password` varchar(64) NOT NULL DEFAULT '0' COMMENT '密码',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '创建时间',
  `org_id` int(11) NOT NULL COMMENT '组织id',
  `enabled` int(11) DEFAULT NULL COMMENT '0无效用户，1是有效用户',
  `phone` varchar(16) DEFAULT NULL COMMENT '手机号',
  `email` varchar(32) DEFAULT NULL COMMENT 'email',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COMMENT='用户信息表';
-- 正在导出表  devicedb.sys_user 的数据：~2 rows (大约)
/*!40000 ALTER TABLE `sys_user` DISABLE KEYS */;
INSERT INTO `sys_user` (`id`, `username`, `password`, `create_time`, `org_id`, `enabled`, `phone`, `email`) VALUES
	(1, 'yanfa1', '$2a$10$xPNoI0sBxOY6Y5Nj1bF6iO6OePqJ8tAJUsD5x5wh6G1BPphhSLcae', '2019-12-24 01:10:14', 3, 1, NULL, NULL),
	(2, 'admin', '$2a$10$xPNoI0sBxOY6Y5Nj1bF6iO6OePqJ8tAJUsD5x5wh6G1BPphhSLcae', '2019-12-24 01:10:18', 1, 1, NULL, NULL);
/*!40000 ALTER TABLE `sys_user` ENABLE KEYS */;
-- 导出  表 devicedb.sys_user_role 结构
CREATE TABLE IF NOT EXISTS `sys_user_role` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `role_id` int(11) NOT NULL DEFAULT '0' COMMENT '角色自增id',
  `user_id` int(11) NOT NULL DEFAULT '0' COMMENT '用户自增id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COMMENT='用户角色关系表';
-- 正在导出表  devicedb.sys_user_role 的数据：~2 rows (大约)
/*!40000 ALTER TABLE `sys_user_role` DISABLE KEYS */;
INSERT INTO `sys_user_role` (`id`, `role_id`, `user_id`) VALUES
	(1, 2, 1),
	(2, 1, 2);

</code></pre>

<h3 id="动态加载数据库数据进行认证与授权">动态加载数据库数据进行认证与授权</h3>

<p>UserDetailsService接 口有一个方法叫做loadUserByUsername, 我们实现动态加载用户、角色、权限信息就是通过实现该方法。函数见名知义:通过用户名加载用户。该方法的返回值就是UserDetails。，UserDetails就是用户信息，即:用户名、密码、该用户所具有的权限。</p>

<pre><code class="language-java">public interface UserDetails extends Serializable {
//获取用户的权限集合
    Collection&lt;? extends GrantedAuthority&gt; getAuthorities();
//获取密码
    String getPassword();
//获取用户名
    String getUsername();
//账号是否过期
    boolean isAccountNonExpired();
//账号是否被锁定
    boolean isAccountNonLocked();
//密码是否过期
    boolean isCredentialsNonExpired();
//账号是否可用
    boolean isEnabled();
}
</code></pre>

<p>配置mybatis</p>

<p>依赖</p>

<pre><code class="language-xml">&lt;!--mysql--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;5.1.47&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--            数据源依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.10&lt;/version&gt;
        &lt;/dependency&gt;
&lt;!--        mybatis--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.3.2&lt;/version&gt;
        &lt;/dependency&gt;
</code></pre>

<p>配置</p>

<pre><code class="language-java">@SpringBootApplication
@MapperScan(basePackages = {&quot;com.mumulx&quot;})//mapper扫描包
public class BasicServerApplication {
</code></pre>

<pre><code class="language-yml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/testdb?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false
    username: root
    password: xxx
    driver-class-name: org.gjt.mm.mysql.Driver
    type: com.alibaba.druid.pool.DruidDataSource
</code></pre>

<p>将之前的静态用户密码删除</p>

<pre><code>#    user:
#      name: admin
#      password: admin
</code></pre>

<p>通过测试类获取加密密码字段插入数据库</p>

<pre><code class="language-java">@RunWith(SpringRunner.class)
@SpringBootTest
public class BootLaunchApplicationTests {
    @Resource
    PasswordEncoder passwordEncoder;
    @Test
    public void contextLoads() {
        System.out.println(passwordEncoder.encode(&quot;123456&quot;));
    }
}
</code></pre>

<p>类</p>

<pre><code class="language-java">public class MyUserDetails implements UserDetails {
    String password; //密码
    String username;  //用户名
    boolean accountNonExpired;   //是否没过期
    boolean accountNonLocked;   //是否没被锁定
    boolean credentialsNonExpired;  //是否没过期
    boolean enabled;  //账号是否可用
    Collection&lt;? extends GrantedAuthority&gt; authorities;  //用户的权限集合
    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        return authorities;
    }
    @Override
    public String getPassword() {
        return password;
    }
    @Override
    public String getUsername() {
        return username;
    }
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }
    @Override
    public boolean isAccountNonLocked() {
        return true;
    }
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }
    @Override
    public boolean isEnabled() {
        return enabled;
    }
    public void setPassword(String password) {
        this.password = password;
    }
    public void setUsername(String username) {
        this.username = username;
    }
    public void setAccountNonExpired(boolean accountNonExpired) {
        this.accountNonExpired = accountNonExpired;
    }
    public void setAccountNonLocked(boolean accountNonLocked) {
        this.accountNonLocked = accountNonLocked;
    }
    public void setCredentialsNonExpired(boolean credentialsNonExpired) {
        this.credentialsNonExpired = credentialsNonExpired;
    }
    public void setEnabled(boolean enabled) {
        this.enabled = enabled;
    }
    public void setAuthorities(Collection&lt;? extends GrantedAuthority&gt; authorities) {
        this.authorities = authorities;
    }
}
</code></pre>

<pre><code class="language-java">public interface MyUserDetailsServiceMapper {
    //根据userID查询用户信息
    @Select(&quot;SELECT username,password,enabled\n&quot; +
            &quot;FROM sys_user u\n&quot; +
            &quot;WHERE u.username = #{userId} or u.phone = #{userId}&quot;)
    MyUserDetails findByUserName(@Param(&quot;userId&quot;) String userId);
    //根据userID查询用户角色列表
    @Select(&quot;SELECT role_code\n&quot; +
            &quot;FROM sys_role r\n&quot; +
            &quot;LEFT JOIN sys_user_role ur ON r.id = ur.role_id\n&quot; +
            &quot;LEFT JOIN sys_user u ON u.id = ur.user_id\n&quot; +
            &quot;WHERE u.username = #{userId} or u.phone = #{userId}&quot;)
    List&lt;String&gt; findRoleByUserName(@Param(&quot;userId&quot;) String userId);
    //根据用户角色查询用户权限
    @Select({
      &quot;&lt;script&gt;&quot;,
         &quot;SELECT url &quot; ,
         &quot;FROM sys_menu m &quot; ,
         &quot;LEFT JOIN sys_role_menu rm ON m.id = rm.menu_id &quot; ,
         &quot;LEFT JOIN sys_role r ON r.id = rm.role_id &quot;,
         &quot;WHERE r.role_code IN &quot;,
         &quot;&lt;foreach collection='roleCodes' item='roleCode' open='(' separator=',' close=')'&gt;&quot;,
            &quot;#{roleCode}&quot;,
         &quot;&lt;/foreach&gt;&quot;,
      &quot;&lt;/script&gt;&quot;
    })
    List&lt;String&gt; findAuthorityByRoleCodes(@Param(&quot;roleCodes&quot;) List&lt;String&gt; roleCodes);
}
</code></pre>

<pre><code class="language-java">@Component
public class MyUserDetailsService implements UserDetailsService {
    @Resource
    private MyUserDetailsServiceMapper myUserDetailsServiceMapper;
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        //加载基础用户信息
        MyUserDetails myUserDetails = myUserDetailsServiceMapper.findByUserName(username);
        //加载用户角色列表
        List&lt;String&gt; roleCodes = myUserDetailsServiceMapper.findRoleByUserName(username);
        //通过用户角色列表加载用户的资源权限列表
        List&lt;String&gt; authorties = myUserDetailsServiceMapper.findAuthorityByRoleCodes(roleCodes);
        //角色是一个特殊的权限，ROLE_前缀
        roleCodes = roleCodes.stream()
                .map(rc -&gt; &quot;ROLE_&quot; +rc)
                .collect(Collectors.toList());
        authorties.addAll(roleCodes);
        myUserDetails.setAuthorities(
                AuthorityUtils.commaSeparatedStringToAuthorityList(
                        String.join(&quot;,&quot;,authorties)
                )
        );
        return myUserDetails;
    }
}
</code></pre>

<p>配置</p>

<p>SecurityConfig</p>

<pre><code class="language-java">@Resource
MyUserDetailsService myUserDetailsService;
 @Override
 public void configure(AuthenticationManagerBuilder auth) throws Exception {
	 auth.userDetailsService(myUserDetailsService)
 		 .passwordEncoder(passwordEncoder());
 }  
</code></pre>

<pre><code class="language-java"> //.antMatchers(&quot;/syslog&quot;,&quot;/sususer&quot;)
 //.hasAnyRole(&quot;admin&quot;)//admin用户可以访问 .hasAnyAuthority(&quot;ROLE_admin&quot;)，另一种写法  角色
 .antMatchers(&quot;/syslog&quot;).hasAuthority(&quot;/sys_log&quot;)//通过权限进行配置
 .antMatchers(&quot;/sysuser&quot;).hasAuthority(&quot;/sys_user&quot;)  //前面是资源，后面是资源id
</code></pre>

<p>测试</p>

<h3 id="动态加载资源鉴权规则">动态加载资源鉴权规则</h3>

<p>将</p>

<pre><code class="language-java"> .antMatchers(&quot;/biz1&quot;,&quot;/biz2&quot;)//需要对外暴漏的资源的路径，user用户和admin用户可以访问
 .hasAnyAuthority(&quot;ROLE_user&quot;,&quot;ROLE_admin&quot;)//user用户和admin用户  权限
 //.antMatchers(&quot;/syslog&quot;,&quot;/sususer&quot;)
 //.hasAnyRole(&quot;admin&quot;)//admin用户可以访问 .hasAnyAuthority(&quot;ROLE_admin&quot;)，另一种写法  角色
 .antMatchers(&quot;/syslog&quot;).hasAuthority(&quot;/syslog&quot;)//通过权限进行配置
 .antMatchers(&quot;/sysuser&quot;).hasAuthority(&quot;/sysuser&quot;)  //前面是资源，后面是资源id
 .anyRequest().authenticated()
</code></pre>

<p>变成动态的</p>

<pre><code class="language-java">@Component(&quot;rabcService&quot;)
public class MyRBACService {
  private AntPathMatcher antPathMatcher = new AntPathMatcher();
    @Resource
    private MyRBACServiceMapper myRBACServiceMapper;
    /**
     * 判断某用户是否具有该request资源的访问权限
     */
    public boolean hasPermission(HttpServletRequest request, Authentication authentication){
        //获取验证主体
        Object principal = authentication.getPrincipal();
        if(principal instanceof UserDetails){
            String username = ((UserDetails)principal).getUsername();
            List&lt;String&gt; urls = myRBACServiceMapper.findUrlsByUserName(username);
            return urls.stream().anyMatch(
                    url -&gt; antPathMatcher.match(url,request.getRequestURI())
            );
        }
        return false;
    }
}
</code></pre>

<pre><code class="language-java">public interface MyRBACServiceMapper {
    @Select(&quot;SELECT url\n&quot; +
            &quot;FROM sys_menu m\n&quot; +
            &quot;LEFT JOIN sys_role_menu rm ON m.id = rm.menu_id\n&quot; +
            &quot;LEFT JOIN sys_role r ON r.id = rm.role_id\n&quot; +
            &quot;LEFT JOIN sys_user_role ur ON r.id = ur.role_id\n&quot; +
            &quot;LEFT JOIN sys_user u ON u.id = ur.user_id\n&quot; +
            &quot;WHERE u.username = #{userId} or u.phone = #{userId}&quot;)
    List&lt;String&gt; findUrlsByUserName(@Param(&quot;userId&quot;) String userId);
}
</code></pre>

<p>配置</p>

<pre><code class="language-java">.antMatchers(&quot;/login.html&quot;,&quot;login&quot;).permitAll()//哪些请求不需要验证
.antMatchers(&quot;/index&quot;).authenticated()//
.anyRequest().access(&quot;@rabcService.hasPermission(request,authentication)&quot;)//除了上面的配置外的所有请求都需要通过rabcService的hasPermission方法进行判断是否有权限
</code></pre>

<p>测试</p>

<h3 id="权限表达式的使用方法">权限表达式的使用方法</h3>

<pre><code class="language-java">&quot;@rabcService.hasPermission(request,authentication)&quot;
</code></pre>

<pre><code class="language-java">//.antMatchers(&quot;/login.html&quot;,&quot;login&quot;).permitAll()//哪些请求不需要验证
.antMatchers(&quot;/login.html&quot;,&quot;login&quot;).access(&quot;permitAll()&quot;)//与上面写法等同
</code></pre>

<p>常用权限表达式</p>

<table>
<thead>
<tr>
<th>表达式</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>hasRole([role])</td>
<td>用户拥有制定的角色时返回true （Spring security默认会带有ROLE_前缀）</td>
</tr>

<tr>
<td>hasAnyRole([role1,role2])</td>
<td>用户拥有任意一个制定的角色时返回true</td>
</tr>

<tr>
<td>hasAuthority([authority])</td>
<td>等同于hasRole,但不会带有ROLE_前缀</td>
</tr>

<tr>
<td>hasAnyAuthority([auth1,auth2])</td>
<td>等同于hasAnyRole</td>
</tr>

<tr>
<td>permitAll</td>
<td>永远返回true</td>
</tr>

<tr>
<td>denyAll</td>
<td>永远返回false</td>
</tr>

<tr>
<td>authentication</td>
<td>当前登录用户的authentication对象</td>
</tr>

<tr>
<td>fullAuthenticated</td>
<td>当前用户既不是anonymous也不是rememberMe用户时返回true</td>
</tr>

<tr>
<td>hasIpAddress(&lsquo;192.168.1.0/24&rsquo;))</td>
<td>请求发送的IP匹配时返回true</td>
</tr>
</tbody>
</table>

<h4 id="权限表达式在全局配置中的使用">权限表达式在全局配置中的使用</h4>

<pre><code class="language-java">.antMatchers(&quot;/login.html&quot;,&quot;login&quot;).access(&quot;permitAll()&quot;)//与上面写法等同
.antMatchers(&quot;/system/*&quot;).access(&quot;hasAnyRole('admin') or hasAnyAuthority('ROLE_admin')&quot;)
</code></pre>

<h4 id="方法级别的安全控制">方法级别的安全控制</h4>

<ul>
<li>@PreAuthorize</li>
<li>@ PreFilter</li>
<li>@ PostAuthorize</li>
<li>@ PostFilter</li>
</ul>

<p>开启</p>

<pre><code class="language-java">@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig  extends WebSecurityConfigurerAdapter {
</code></pre>

<p>编写规则</p>

<pre><code class="language-java">@Service
public class MethodELService {
    //在该方法执行之前先进判断hasRole('admin')
    @PreAuthorize(&quot;hasRole('admin')&quot;)
    public List&lt;PersonDemo&gt; findAll(){
        return null;
    }
    //先执行方法，方法执行完毕后对返回值进行判断
    @PostAuthorize(&quot;returnObject.name == authentication.name&quot;)
    public PersonDemo findOne(){
        String authName =
                getContext().getAuthentication().getName();
        //System.out.println(authName);
        return new PersonDemo(&quot;admin&quot;);
    }
    //对参数ids进行过滤，过滤的规则为value=&quot;filterObject%2==0&quot;
    @PreFilter(filterTarget=&quot;ids&quot;, value=&quot;filterObject%2==0&quot;)
    public void delete(List&lt;Integer&gt; ids, List&lt;String&gt; usernames) {
        System.out.println();
    }
//针对返回值进行过滤，保留返回值中的name==authentication.name(认证主体的对象)
    @PostFilter(&quot;filterObject.name == authentication.name&quot;)
    public List&lt;PersonDemo&gt; findAllPD(){
        List&lt;PersonDemo&gt; list = new ArrayList&lt;&gt;();
        list.add(new PersonDemo(&quot;kobe&quot;));
        list.add(new PersonDemo(&quot;admin&quot;));
        return list;
    }
}
</code></pre>

<p>就是一个特殊的service，在controller中调用，当规则不符合时会抛出异常</p>

<pre><code class="language-java">// 具体业务一
@GetMapping(&quot;/biz1&quot;)
public String updateOrder() {
    /*List&lt;Integer&gt; ids = new ArrayList&lt;&gt;();
        ids.add(1);
        ids.add(2);
        methodELService.delete(ids,null);*/
    //List&lt;PersonDemo&gt; pds = methodELService.findAllPD();
    // methodELService.findAll();
    return &quot;biz1&quot;;
}
</code></pre>

<h3 id="rememberme记住密码">REMEMBERME记住密码</h3>

<p>最简实现</p>

<p>后端配置</p>

<pre><code class="language-java">http.rememberMe(); //实现记住我自动登录配置， 核心的代码只有这一行
</code></pre>

<p>前端实现</p>

<pre><code class="language-html">&lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot;/&gt;记住密码&lt;/1abe1&gt;
</code></pre>

<p>开启</p>

<p>springsecurityConfig中</p>

<pre><code class="language-java"> @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.rememberMe()//记住功能
                .and().csrf().disable()//关掉csrf，否则会将我们的请求当作是一个不合法的
                .formLogin()
</code></pre>

<p>页面添加组件</p>

<pre><code class="language-html">&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
    &lt;span&gt;用户名称&lt;/span&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot;/&gt; &lt;br&gt;
    &lt;span&gt;用户密码&lt;/span&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot;/&gt; &lt;br&gt;
    &lt;input type=&quot;button&quot; onclick=&quot;login()&quot; value=&quot;登陆&quot;&gt;
    &lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot;&gt; 记住密码&lt;/label&gt;
&lt;/form&gt;

    function login() {
        var username = $(&quot;#username&quot;).val();
        var password = $(&quot;#password&quot;).val();
        var rememberMe = $(&quot;#remember-me&quot;).is(&quot;:checked&quot;);

        if (username === &quot;&quot; || password === &quot;&quot;) {
            alert('用户名或密码不能为空');
            return;
        }
        $.ajax({
            type: &quot;POST&quot;,
            url: &quot;/login&quot;,
            data: {
                &quot;username&quot;: username,
                &quot;password&quot;: password,
                &quot;remember-me&quot;:rememberMe//名称一定是remember-me
            },
</code></pre>

<p>测试</p>

<p>勾选记住密码后，会新增一个cookie</p>

<p>值为</p>

<pre><code>YWRtaW46MTU4NDYyNDY1ODE2MTo2NTgyZGExZjRmYmQ5NWUyZTdmNjAwNGI4YjcxZDUzNg
</code></pre>

<p>使用base64进行解密后的到</p>

<pre><code>admin:1584624658161:6582da1f4fbd95e2e7f6004b8b71d536
用户：时间（从xxx年到现在的总的秒数）：
</code></pre>

<ul>
<li>RememberMeToken = username, expiry Time, signatureValue的Base64加密</li>

<li><p>signatureValue = username、 expirationTime和passwod和一个预定义的key,并将他们经过MD5进行签名。</p>

<pre><code>TokenBasedRememberMeServices类中

protected String makeTokenSignature(long tokenExpiryTime, String username, String password) {
    String data = username + &quot;:&quot; + tokenExpiryTime + &quot;:&quot; + password + &quot;:&quot; + this.getKey();
    MessageDigest digest;
    try {
        digest = MessageDigest.getInstance(&quot;MD5&quot;);
    } catch (NoSuchAlgorithmException var8) {
        throw new IllegalStateException(&quot;No MD5 algorithm available!&quot;);
    }
    return new String(Hex.encode(digest.digest(data.getBytes())));
}
</code></pre></li>
</ul>

<p><strong>个性化配置</strong></p>

<ul>
<li>tokenValiditySeconds用于设置token的有效期，默认是2周。</li>
<li>通过rememberMeParameter设置from表单“自动登录”勾选框的参数名称。</li>

<li><p>rememberMeCookieName设 置了保存在 浏览器端的cookie的名称。</p>

<pre><code class="language-java">http.rememberMe()
    .rememberMeParameter(&quot;remember-me&quot;)//传参的名称即，ajax请求中&quot;remember-me&quot;:rememberMe
    .rememberMeCookieName(&quot;remember-me-cookie&quot;)//cookie的name
    .tokenValiditySeconds(2*24*60*60)//过期时间：两天
</code></pre></li>
</ul>

<p>将cookie信息存放到内存中</p>

<h4 id="使用数据库实现remember">使用数据库实现remember</h4>

<p><img src="/resources/技术框架/Spring家族/sdfasdf.png" alt="使用数据库实现remember" /></p>

<p>创建表</p>

<pre><code class="language-sql">CREATE TABLE `persistent_logins` (
  `username` varchar(64) NOT NULL,
  `series` varchar(64) NOT NULL,
  `token` varchar(64) NOT NULL,
  `last_used` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`series`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</code></pre>

<p>配置</p>

<pre><code class="language-java">SecurityConfig类

@Resource
private DataSource dataSource;//对应的是application-dev.yml中的datasource
@Bean
public PersistentTokenRepository persistentTokenRepository(){
	JdbcTokenRepositoryImpl tokenRepository = new JdbcTokenRepositoryImpl();
	tokenRepository.setDataSource(dataSource);
	return tokenRepository;
}
</code></pre>

<pre><code class="language-java">rememberMeParameter(&quot;remember-me&quot;)//传参的名称即，ajax请求中&quot;remember-me&quot;:rememberMe
.rememberMeCookieName(&quot;remember-me-cookie&quot;)//cookie的name
.tokenValiditySeconds(2*24*60*60)//过期时间：两天
.tokenRepository(persistentTokenRepository())
</code></pre>

<p>测试</p>

<p>数据库中增加了数据</p>

<h3 id="用户退出功能的实现">用户退出功能的实现</h3>

<p>最简及最佳实践</p>

<p>后端配置</p>

<pre><code class="language-java">@Override
protected void configure(final HttpSecurity http) throws Exception {
	http.logout();
}	
</code></pre>

<p>前端代码</p>

<pre><code class="language-html">&lt;a href-=&quot;/logout&quot; &gt;退出&lt;/a&gt;
</code></pre>

<p>配置</p>

<pre><code class="language-java">@Override
protected void configure(HttpSecurity http) throws Exception {
	http.logout()

</code></pre>

<p>index.html中增加代码</p>

<pre><code class="language-html">&lt;a href=&quot;/logout&quot;&gt;退出&lt;/a&gt;
</code></pre>

<p>测试，将数据库中的信息删除</p>

<p>页面返回到login.html</p>

<p>logout的默认行为</p>

<ul>
<li>当前session失效，即: logout的 核心需求，session失 效就是访问权限的回收。</li>
<li>删除当前用户的remember-me“记住我”功能信息</li>
<li>clear清除当前的SecurityContext</li>
<li>重定向到登录页面，loginPage配置项指定的页面</li>
</ul>

<h4 id="个性化配置">个性化配置</h4>

<ul>
<li>通过指定logoutUr|配置改变退出请求的默认路径，当然html退出按钮的请求url也要修改</li>
<li>通过指定logoutSuccessUrl配置，来显式指定退出之后的跳转页面</li>
<li>还可以使用deleteCookies删除指定的cookie,参数为cookie的名称</li>
</ul>

<p>配置</p>

<pre><code class="language-java"> http.logout()
 	.logoutUrl(&quot;/logout&quot;)//a标签的href请求路径
 	.logoutSuccessUrl(&quot;.login.html&quot;)//成功后重定向的页面
 	.deleteCookies(&quot;JSESSIONID&quot;)//将JESSIONID一起删除
</code></pre>

<p>重定向的页面要设置访问权限</p>

<pre><code class="language-java">.authorizeRequests()
                    .antMatchers(&quot;/login.html&quot;,&quot;login&quot;).permitAll()//哪些请求不需要验证
</code></pre>

<h4 id="logoutsuccesshlandler">LogoutSuccesshlandler</h4>

<ul>
<li>编码实现个性化退出功能</li>
<li>注意logoutSuccessUrl不要与logoutSuccessHandler一起使用，否则logoutSuccessHandler将失效。</li>
</ul>

<p>当用户退出时还想做一些其他的操作</p>

<p>配置</p>

<pre><code class="language-java">
@Component
public class MyLogoutSuccessHandler implements LogoutSuccessHandler {
    @Override
    public void onLogoutSuccess(HttpServletRequest request,
                                HttpServletResponse response,
                                Authentication authentication)
            throws IOException, ServletException {
        //写一些业务逻辑，比如：登录时间的统计
        response.sendRedirect(&quot;/login.html&quot;);
    }
}
</code></pre>

<p>springsecurityConfig</p>

<pre><code class="language-java">@Resource
MyLogoutSuccessHandler myLogoutSuccessHandler;
</code></pre>

<pre><code class="language-java"> http.logout()
 	.logoutUrl(&quot;/logout&quot;)
 	//.logoutSuccessUrl(&quot;/login.html&quot;)
 	.deleteCookies(&quot;JSESSIONID&quot;)
 	.logoutSuccessHandler(myLogoutSuccessHandler)//与logoutSuccessUrl不能同时使用
</code></pre>

<h3 id="图片验证码的实现方案">图片验证码的实现方案</h3>

<p>谜面用于展现，谜底用于校验</p>

<ul>
<li>对于字符型验证码。比如:谜面是显示字符串&rdquo;ABGH&rdquo;的图片，谜底是字符串&rdquo;ABGH&rdquo;</li>
<li>对于计算类验证码。比如:谜面是“1+1=”的图片，谜底是“2”</li>
<li>对于拖拽类的验证码。比如:谜面是一个拖拽式的拼图，谜底是拼图位置的坐标</li>
</ul>

<h4 id="session存储验证码">session存储验证码</h4>

<p><img src="/resources/技术框架/Spring家族/session保存验证码.png" alt="session存储验证码" /></p>

<p><strong>图片验证码开发三部曲</strong></p>

<ul>
<li>验证码工具配置</li>
<li>验证码加载(重点)</li>
<li>验证码校验(重点)</li>
</ul>

<p><strong>验证码工具类库</strong></p>

<ul>
<li>生成验证码文字或其他用于校验的数据形式(即谜底)</li>
<li>生成验证码前端显示图片或拼图等(即谜面)</li>
<li>用于校验用户输入与谜底的校验方法(如果是纯文字，就自己比对以下就可以。如果是基于物理图形拖拽、旋转等方式，需要专用的校验方法)</li>
</ul>

<p><strong>使用</strong></p>

<p>添加依赖</p>

<pre><code class="language-xml">&lt;!--        验证码--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.penggle&lt;/groupId&gt;
            &lt;artifactId&gt;kaptcha&lt;/artifactId&gt;
            &lt;version&gt;2.3.2&lt;/version&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
                    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
</code></pre>

<p>配置</p>

<p>yml配置方式不能实现，因此需要使用properties文件</p>

<p>新建kaptcha.properties</p>

<pre><code class="language-properties">kaptcha.border=no
kaptcha.border.color=105,179,90
kaptcha.image.width=100
kaptcha.image.height=45
kaptcha.session.key=code
kaptcha.textproducer.font.color=blue
kaptcha.textproducer.font.size=35
kaptcha.textproducer.char.length=4
kaptcha.textproducer.font.names=宋体,楷体,微软雅黑
</code></pre>

<p>配置加载类让spring认识该配置文件</p>

<p>CaptchaConfig</p>

<pre><code class="language-java">@Configuration
@PropertySource(value = {&quot;classpath:kaptcha.properties&quot;})
public class CaptchaConfig {
    @Value(&quot;${kaptcha.border}&quot;)
    private String border;
    @Value(&quot;${kaptcha.border.color}&quot;)
    private String borderColor;
    @Value(&quot;${kaptcha.textproducer.font.color}&quot;)
    private String fontColor;
    @Value(&quot;${kaptcha.image.width}&quot;)
    private String imageWidth;
    @Value(&quot;${kaptcha.image.height}&quot;)
    private String imageHeight;
    @Value(&quot;${kaptcha.session.key}&quot;)
    private String sessionKey;
    @Value(&quot;${kaptcha.textproducer.char.length}&quot;)
    private String charLength;
    @Value(&quot;${kaptcha.textproducer.font.names}&quot;)
    private String fontNames;
    @Value(&quot;${kaptcha.textproducer.font.size}&quot;)
    private String fontSize;
    @Bean(name = &quot;captchaProducer&quot;)
    public DefaultKaptcha getKaptchaBean(){
        DefaultKaptcha defaultKaptcha = new DefaultKaptcha();
        Properties properties = new Properties();
        properties.setProperty(&quot;kaptcha.border&quot;, border);
        properties.setProperty(&quot;kaptcha.border.color&quot;, borderColor);
        properties.setProperty(&quot;kaptcha.textproducer.font.color&quot;, fontColor);
        properties.setProperty(&quot;kaptcha.image.width&quot;, imageWidth);
        properties.setProperty(&quot;kaptcha.image.height&quot;, imageHeight);
        properties.setProperty(&quot;kaptcha.session.key&quot;, sessionKey);
        properties.setProperty(&quot;kaptcha.textproducer.char.length&quot;, charLength);
        properties.setProperty(&quot;kaptcha.textproducer.font.names&quot;, fontNames);
        properties.setProperty(&quot;kaptcha.textproducer.font.size&quot;,fontSize);
        defaultKaptcha.setConfig(new Config(properties));
        return defaultKaptcha;
    }
}
</code></pre>

<p>新建controller：CaptchaController</p>

<pre><code class="language-java">@RestController
public class CaptchaController {
    @Resource
    DefaultKaptcha captchaProducer;
    @RequestMapping(value=&quot;/kaptcha&quot;,method = RequestMethod.GET)
    public void kaptcha(HttpSession session, HttpServletResponse response) throws IOException {
        response.setDateHeader(&quot;Expires&quot;, 0);
        response.setHeader(&quot;Cache-Control&quot;, &quot;no-store, no-cache, must-revalidate&quot;);
        response.addHeader(&quot;Cache-Control&quot;, &quot;post-check=0, pre-check=0&quot;);
        response.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);
        response.setContentType(&quot;image/jpeg&quot;);
        String capText = captchaProducer.createText();
        session.setAttribute(MyContants.CAPTCHA_SESSION_KEY,
                new CaptchaCode(capText,2 * 60));//两分钟
        //将验证码写回到浏览器中
        try(ServletOutputStream out = response.getOutputStream()){
            BufferedImage bufferedImage = captchaProducer.createImage(capText);
            ImageIO.write(bufferedImage,&quot;jpg&quot;,out);
            out.flush();
        }
    }
}

</code></pre>

<p>工具类MyContants</p>

<pre><code class="language-java">public class MyContants {
    public static final String CAPTCHA_SESSION_KEY = &quot;captcha_key&quot;;
    public static final String SMS_SESSION_KEY = &quot;sms_key&quot;;
}
</code></pre>

<p>新建验证码：CaptchaCode</p>

<pre><code class="language-java">public class CaptchaCode {
    //验证码
    private String code;
    //过期时间
    private LocalDateTime expireTime;
    public CaptchaCode(String code, int expireAfterSeconds){
        this.code = code;
        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);
    }
    //判断当前验证码是否过期
    public boolean isExpired(){
        return  LocalDateTime.now().isAfter(expireTime);
    }
    public String getCode() {
        return code;
    }
}
</code></pre>

<p>前端页面添加验证码login.html</p>

<pre><code class="language-html">&lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
    &lt;span&gt;用户名称&lt;/span&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot;/&gt; &lt;br&gt;
    &lt;span&gt;用户密码&lt;/span&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot;/&gt; &lt;br&gt;
    &lt;span&gt;验证码&lt;/span&gt;&lt;input type=&quot;text&quot; name=&quot;captchaCode&quot; id=&quot;captchaCode&quot;/&gt;
    &lt;img src=&quot;/kaptcha&quot; id=&quot;kaptcha&quot; width=&quot;100px&quot; height=&quot;45px&quot;/&gt; &lt;br&gt;

    &lt;input type=&quot;button&quot; onclick=&quot;login()&quot; value=&quot;登陆&quot;&gt;
    &lt;label&gt;&lt;input type=&quot;checkbox&quot; name=&quot;remember-me&quot; id=&quot;remember-me&quot;&gt; 记住密码&lt;/label&gt;
&lt;/form&gt;
</code></pre>

<p>页面js</p>

<pre><code class="language-javascript">    //页面加载时加载验证码
    window.onload = function () {
        var kaptchaImg = document.getElementById(&quot;kaptcha&quot;);
        kaptchaImg.onclick = function () {
            kaptchaImg.src = &quot;/kaptcha?&quot; + Math.floor(Math.random() * 100)
        }
    };
</code></pre>

<p>开放验证码访问路径SecurityConfig</p>

<pre><code class="language-java">.antMatchers(&quot;/login.html&quot;,&quot;login&quot;,&quot;/kaptcha&quot;).permitAll()//哪些请求不需要验证
</code></pre>

<p>测试</p>

<p>访问</p>

<pre><code>http://localhost:8888/login.html
</code></pre>

<h4 id="验证码验证">验证码验证</h4>

<p>图片验证码过滤器</p>

<ul>
<li>编写自定义图片验证码过滤器CaptchaCodeFilter,过滤器中拦截登录请求</li>
<li>过滤器中从seesion获取验证码文字与用户输入比对，比对通过执行其他过滤器链</li>
<li>比对不通过，抛出SessionAuthenticationException异常，交给AuthenticationFailureHandler处理</li>
<li>最后将Captcha odeFilter放在UsernamePasswordAuthenticationFilter过滤器前执行。</li>
</ul>

<p>新建过滤器CaptchaCodeFilter</p>

<pre><code class="language-java">
@Component
public class CaptchaCodeFilter extends OncePerRequestFilter {
    @Resource
    MyAuthenticationFailureHandler myAuthenticationFailureHandler;
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {
        if(StringUtils.equals(&quot;/login&quot;,request.getRequestURI())
                &amp;&amp; StringUtils.equalsIgnoreCase(request.getMethod(),&quot;post&quot;)){
            try{
                //验证谜底与用户输入是否匹配
                validate(new ServletWebRequest(request));
            }catch(AuthenticationException e){
                //交给登录失败处理类取值处理
                myAuthenticationFailureHandler.onAuthenticationFailure(
                        request,response,e
                );
                return;
            }
        }
        filterChain.doFilter(request,response);
    }
    private void validate(ServletWebRequest request) throws ServletRequestBindingException {
        HttpSession session = request.getRequest().getSession();
        String codeInRequest = ServletRequestUtils.getStringParameter(
                request.getRequest(),&quot;captchaCode&quot;);
        if(StringUtils.isEmpty(codeInRequest)){
            throw new SessionAuthenticationException(&quot;验证码不能为空&quot;);
        }
        // 3. 获取session池中的验证码谜底
        CaptchaCode codeInSession = (CaptchaCode)
                session.getAttribute(MyContants.CAPTCHA_SESSION_KEY);
        if(Objects.isNull(codeInSession)) {
            throw new SessionAuthenticationException(&quot;验证码不存在&quot;);
        }
        // 4. 校验服务器session池中的验证码是否过期
        if(codeInSession.isExpired()) {
            session.removeAttribute(MyContants.CAPTCHA_SESSION_KEY);
            throw new SessionAuthenticationException(&quot;验证码已经过期&quot;);
        }
        // 5. 请求验证码校验
        if(!StringUtils.equals(codeInSession.getCode(), codeInRequest)) {
            throw new SessionAuthenticationException(&quot;验证码不匹配&quot;);
        }
    }
}
</code></pre>

<p>MyAuthenticationFailureHandler处理异常</p>

<pre><code class="language-java">String errorMsg = &quot;用户名或者密码输入错误!&quot;;
if(exception instanceof SessionAuthenticationException){
	errorMsg = exception.getMessage();
}
</code></pre>

<p>SecurityConfig配置</p>

<pre><code class="language-java">//验证码
    @Resource
    CaptchaCodeFilter captchaCodeFilter;
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.addFilterBefore(captchaCodeFilter, UsernamePasswordAuthenticationFilter.class)
            .logout()
</code></pre>

<p>前端页面传递验证码的值</p>

<pre><code class="language-javascript">function login() {
        var username = $(&quot;#username&quot;).val();
        var password = $(&quot;#password&quot;).val();
        //验证码
        var captchaCode = $(&quot;#captchaCode&quot;).val();
        var rememberMe = $(&quot;#remember-me&quot;).is(&quot;:checked&quot;);
        if (username === &quot;&quot; || password === &quot;&quot;) {
            alert('用户名或密码不能为空');
            return;
        }
        $.ajax({
            type: &quot;POST&quot;,
            url: &quot;/login&quot;,
            data: {
                &quot;username&quot;: username,
                &quot;password&quot;: password,
                &quot;captchaCode&quot;:captchaCode,
                &quot;remember-me&quot;:rememberMe//名称一定是remember-me
            },
            success: function (json) {
                if(json.isok){
                    location.href = json.data;
                }else{
                    alert(json.message)
                }
            },
            error: function (e) {
                console.log(e.responseText);
            }
        });
    }
</code></pre>

<p>测试</p>

<h4 id="共享session存储验证码">共享session存储验证码</h4>

<p><img src="/resources/技术框架/Spring家族/共享session.png" alt="共享session存储验证码" /></p>

<h4 id="基于对称算法的验证码">基于对称算法的验证码</h4>

<p><img src="/resources/技术框架/Spring家族/基于对称算法的验证码.png" alt="基于对称算法的验证码" /></p>

<h3 id="短信验证码登录功能">短信验证码登录功能</h3>

<p><img src="/resources/技术框架/Spring家族/uml01.png" alt="短信验证码登录功能" /></p>

<ul>
<li>输入手机号码，点击获取按钮，服务端接受请求发送短信</li>
<li>用户输入验证码点击登录</li>
<li>手机号码必须属于系统的注册用户，并且唯一</li>
<li>手机号与验证码正确性及其关系必须经过校验</li>
<li>登录后用户具有手机号对应的用户的角色及权限</li>
</ul>

<p>实现步骤</p>

<ul>
<li>获取短信验证码</li>
<li>短信验证码校验过滤器</li>
<li>短信验证码登录认证过滤器</li>
<li>综合配置</li>
</ul>

<h4 id="获取短信验证码">获取短信验证码</h4>

<p>新建controller：SmsController</p>

<pre><code>@Slf4j
@RestController
public class SmsController {
    @Resource
    MyUserDetailsServiceMapper myUserDetailsServiceMapper;
    @RequestMapping(value = &quot;/smscode&quot;,method = RequestMethod.GET)
    public AjaxResponse sms(@RequestParam String mobile, HttpSession session){
        //手机号是否已经被注册
        MyUserDetails myUserDetails = myUserDetailsServiceMapper.findByUserName(mobile);
        if(myUserDetails == null){
            return AjaxResponse.error(
                    new CustomException(CustomExceptionType.USER_INPUT_ERROR,
                            &quot;您输入的手机号未曾注册&quot;)
            );
        }
        //四位随机数字
        SmsCode smsCode = new SmsCode(
                RandomStringUtils.randomNumeric(4),60,mobile
        );
        //TODO 调用短信服务提供商的接口发送短信（要进行购买，这里使用日志模拟）
        log.info(smsCode.getCode()  + &quot;+&gt;&quot; + mobile);
        session.setAttribute(MyContants.SMS_SESSION_KEY,smsCode);
        //AjaxResponse：封装了返回给前端页面信息的数据结构后，进行了统一
        return AjaxResponse.success(&quot;短信验证码已经发送&quot;);
    }
}
</code></pre>

<p>新建短信验证码实体类</p>

<pre><code class="language-java">public class SmsCode {
    private String code; //短信验证码
    private LocalDateTime expireTime; //过期时间
    private String mobile;
    public SmsCode(String code, int expireAfterSeconds,String mobile){
        this.code = code;
        this.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);
        this.mobile = mobile;
    }
    public boolean isExpired(){
        return  LocalDateTime.now().isAfter(expireTime);
    }
    public String getCode() {
        return code;
    }
    public String getMobile() {
        return mobile;
    }
}
</code></pre>

<p>修改mapper增加查询手机号功能</p>

<pre><code class="language-java">    //根据userID查询用户信息
    @Select(&quot;SELECT username,password,enabled\n&quot; +
            &quot;FROM sys_user u\n&quot; +
            &quot;WHERE u.username = #{userId} or u.phone = #{userId}&quot;)
    MyUserDetails findByUserName(@Param(&quot;userId&quot;) String userId);
</code></pre>

<p>开放权限</p>

<pre><code class="language-java">.antMatchers(&quot;/login.html&quot;,&quot;login&quot;,&quot;/kaptcha&quot;,&quot;/smscode&quot;).permitAll()//哪些请求不需要验证
</code></pre>

<h4 id="短信验证码校验过滤器">短信验证码校验过滤器</h4>

<p>短信验证码校验过滤器-校验规则</p>

<ul>
<li>用户登录时手机号不能为空</li>
<li>用户登录时短信验证码不能为空</li>
<li>用户登陆时在session中必须存在对应的校验谜底(获取验证码时存放的)</li>
<li>用户登录时输入的短信验证码必须和</li>
<li>谜底”中的验证码一致</li>
<li>用户登录时输入的手机号必须和‘</li>
<li>“谜底”中保存的手机号一致</li>
<li>用户登录时输入的手机号必须是系统注册用户的手机号，并且唯一</li>
</ul>

<p>SmsCodeValidateFilter</p>

<pre><code class="language-java">@Component
public class SmsCodeValidateFilter extends OncePerRequestFilter {
    @Resource
    MyUserDetailsServiceMapper myUserDetailsServiceMapper;
    @Resource
    MyAuthenticationFailureHandler myAuthenticationFailureHandler;
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {
        if(StringUtils.equals(&quot;/smslogin&quot;,request.getRequestURI())
                &amp;&amp; StringUtils.equalsIgnoreCase(request.getMethod(),&quot;post&quot;)){
            try{
                //验证谜底与用户输入是否匹配
                validate(new ServletWebRequest(request));
            }catch(AuthenticationException e){
                myAuthenticationFailureHandler.onAuthenticationFailure(
                        request,response,e
                );
                return;
            }
        }
        filterChain.doFilter(request,response);
    }
    //验证规则
    private void validate(ServletWebRequest request) throws ServletRequestBindingException {
        HttpSession session = request.getRequest().getSession();
        SmsCode codeInSession = (SmsCode)session.getAttribute(MyContants.SMS_SESSION_KEY);
        String mobileInRequest = request.getParameter(&quot;mobile&quot;);
        String codeInRequest = request.getParameter(&quot;smsCode&quot;);
        if(StringUtils.isEmpty(mobileInRequest)){
            throw new SessionAuthenticationException(&quot;手机号码不能为空&quot;);
        }
        if(StringUtils.isEmpty(codeInRequest)) {
            throw new SessionAuthenticationException(&quot;短信验证码不能为空&quot;);
        }
        if(Objects.isNull(codeInSession)) {
            throw new SessionAuthenticationException(&quot;短信验证码不存在&quot;);
        }
        if(codeInSession.isExpired()) {
            session.removeAttribute(MyContants.SMS_SESSION_KEY);
            throw new SessionAuthenticationException(&quot;短信验证码已经过期&quot;);
        }
        if(!codeInSession.getCode().equals(codeInRequest)) {
            throw new SessionAuthenticationException(&quot;短信验证码不正确&quot;);
        }
        if(!codeInSession.getMobile().equals(mobileInRequest)) {
            throw new SessionAuthenticationException(&quot;短信发送目标与您输入的手机号不一致&quot;);
        }
        MyUserDetails myUserDetails = myUserDetailsServiceMapper.findByUserName(mobileInRequest);
        if(Objects.isNull(myUserDetails)){
            throw new SessionAuthenticationException(&quot;您输入的手机号不是系统的注册用户&quot;);
        }
        session.removeAttribute(MyContants.SMS_SESSION_KEY);
    }
}
</code></pre>

<p>开放请求路径</p>

<pre><code class="language-java">.antMatchers(&quot;/login.html&quot;,&quot;login&quot;,&quot;/kaptcha&quot;,&quot;/smscode&quot;,&quot;/smslogin&quot;).permitAll()//哪些请求不需要验证
</code></pre>

<h4 id="短信验证码登录认证过滤器">短信验证码登录认证过滤器</h4>

<p>短信验证码登录认证过滤器原理</p>

<p><img src="/resources/技术框架/Spring家族/s1df3.png" alt="短信验证码登录认证过滤器" /></p>

<p>参照UsernamePasswordAuthenticationFilter类</p>

<pre><code class="language-java">public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
    public static final String SPRING_SECURITY_FORM_USERNAME_KEY = &quot;username&quot;;
    public static final String SPRING_SECURITY_FORM_PASSWORD_KEY = &quot;password&quot;;
    private String usernameParameter = &quot;username&quot;;
    private String passwordParameter = &quot;password&quot;;
    private boolean postOnly = true;
    public UsernamePasswordAuthenticationFilter() {
        super(new AntPathRequestMatcher(&quot;/login&quot;, &quot;POST&quot;));
    }
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
        if (this.postOnly &amp;&amp; !request.getMethod().equals(&quot;POST&quot;)) {
            throw new AuthenticationServiceException(&quot;Authentication method not supported: &quot; + request.getMethod());
        } else {
            String username = this.obtainUsername(request);
            String password = this.obtainPassword(request);
            if (username == null) {
                username = &quot;&quot;;
            }
            if (password == null) {
                password = &quot;&quot;;
            }
            username = username.trim();
            UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password);
            this.setDetails(request, authRequest);
            return this.getAuthenticationManager().authenticate(authRequest);
        }
    }
    @Nullable
    protected String obtainPassword(HttpServletRequest request) {
        return request.getParameter(this.passwordParameter);
    }
    @Nullable
    protected String obtainUsername(HttpServletRequest request) {
        return request.getParameter(this.usernameParameter);
    }
    protected void setDetails(HttpServletRequest request, UsernamePasswordAuthenticationToken authRequest) {
        authRequest.setDetails(this.authenticationDetailsSource.buildDetails(request));
    }
    public void setUsernameParameter(String usernameParameter) {
        Assert.hasText(usernameParameter, &quot;Username parameter must not be empty or null&quot;);
        this.usernameParameter = usernameParameter;
    }
    public void setPasswordParameter(String passwordParameter) {
        Assert.hasText(passwordParameter, &quot;Password parameter must not be empty or null&quot;);
        this.passwordParameter = passwordParameter;
    }
    public void setPostOnly(boolean postOnly) {
        this.postOnly = postOnly;
    }
    public final String getUsernameParameter() {
        return this.usernameParameter;
    }
    public final String getPasswordParameter() {
        return this.passwordParameter;
    }
}
</code></pre>

<p>参考UsernamePasswordAuthenticationToken类</p>

<pre><code class="language-java">
public class SmsCodeAuthenticationToken extends AbstractAuthenticationToken {
    private static final long serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;
    //存放认证信息，认证之前放的是手机号，认证之后UserDetails
    private final Object principal;
    public SmsCodeAuthenticationToken(Object principal) {
        super(null);
        this.principal = principal;
        setAuthenticated(false);
    }
    public SmsCodeAuthenticationToken(Object principal,
                                      Collection&lt;? extends GrantedAuthority&gt; authorities) {
        super(authorities);
        this.principal = principal;
        super.setAuthenticated(true); // must use super, as we override
    }
    public Object getPrincipal() {
        return this.principal;
    }
    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {
        if (isAuthenticated) {
            throw new IllegalArgumentException(
                    &quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;);
        }
        super.setAuthenticated(false);
    }
    @Override
    public void eraseCredentials() {
        super.eraseCredentials();
    }
    @Override
    public Object getCredentials() {
        return null;
    }
}
</code></pre>

<p>参照DaoAuthenticationProvider类</p>

<pre><code class="language-java">public class SmsCodeAuthenticationProvider implements AuthenticationProvider {
    private UserDetailsService userDetailsService;
    public void setUserDetailsService(UserDetailsService userDetailsService) {
        this.userDetailsService = userDetailsService;
    }
    protected UserDetailsService getUserDetailsService() {
        return userDetailsService;
    }
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        SmsCodeAuthenticationToken authenticationToken = (SmsCodeAuthenticationToken)authentication;
        UserDetails userDetails = userDetailsService.loadUserByUsername((String) authenticationToken.getPrincipal());
        if(userDetails == null){
            throw new InternalAuthenticationServiceException(&quot;无法根据手机号获取用户信息&quot;);
        }
        SmsCodeAuthenticationToken authenticationResult
                = new SmsCodeAuthenticationToken(userDetails,userDetails.getAuthorities());
        authenticationResult.setDetails(authenticationToken.getDetails());
        return authenticationResult;
    }
    @Override
    public boolean supports(Class&lt;?&gt; authentication) {
        return SmsCodeAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
</code></pre>

<h4 id="综合配置">综合配置</h4>

<p>新建验证码配置类SmsCodeSecurityConfig</p>

<pre><code class="language-java">
@Component
public class SmsCodeSecurityConfig
        extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain,HttpSecurity&gt; {
    @Resource
    MyAuthenticationSuccessHandler myAuthenticationSuccessHandler;
    @Resource
    MyAuthenticationFailureHandler myAuthenticationFailureHandler;
    @Resource
    MyUserDetailsService myUserDetailsService;
    @Resource
    SmsCodeValidateFilter smsCodeValidateFilter;
    @Override
    public void configure(HttpSecurity http) throws Exception {
        SmsCodeAuthenticationFilter smsCodeAuthenticationFilter = new SmsCodeAuthenticationFilter();
  smsCodeAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager.class));
        smsCodeAuthenticationFilter.setAuthenticationSuccessHandler(myAuthenticationSuccessHandler);
        smsCodeAuthenticationFilter.setAuthenticationFailureHandler(myAuthenticationFailureHandler);
        SmsCodeAuthenticationProvider smsCodeAuthenticationProvider = new SmsCodeAuthenticationProvider();
        smsCodeAuthenticationProvider.setUserDetailsService(myUserDetailsService);
        http.addFilterBefore(smsCodeValidateFilter,UsernamePasswordAuthenticationFilter.class);
        http.authenticationProvider(smsCodeAuthenticationProvider)
             .addFilterAfter(smsCodeAuthenticationFilter,UsernamePasswordAuthenticationFilter.class);
    }
}
</code></pre>

<p>总配置文件中进行配置</p>

<p>SecurityConfig</p>

<pre><code class="language-java">@Resource
SmsCodeSecurityConfig smsCodeSecurityConfig;

.formLogin()
	//逻辑
	.loginPage(&quot;/login.html&quot;)//登陆页面位置
	.usernameParameter(&quot;username&quot;)//表单用户名name
	.passwordParameter(&quot;password&quot;)//表单密码name
	.loginProcessingUrl(&quot;/login&quot;)//  登录验证请求  post方式的表单action
	//.defaultSuccessUrl(&quot;/index&quot;)//成功后的跳转页面
	//.failureUrl(&quot;/login.html&quot;)
	.successHandler(myAuthenticationSuccessHandler)//不能与defaultSuccessUrl一起使用
	.failureHandler(myAuthenticationFailureHandler)
.and().apply(smsCodeSecurityConfig).and()
</code></pre>

<p>测试</p>

<p>数据库添加用户yanfa1手机号123456789</p>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接: </strong>
      <a href="https://mumulx.github.io/2020/03/springsecurity/" title="SpringSecurity自学笔记" target="_blank" rel="external">https://mumulx.github.io/2020/03/springsecurity/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/mumulx" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://mumulx.github.io/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/mumulx" target="_blank"><span class="text-dark">木木就是两个木</span><small class="ml-1x">木木</small></a></h3>
        <div>愿生活不太拥挤，愿笑容不必刻意。</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://mumulx.github.io/2020/03/springbootcloud/" title="SpringCloud自学笔记"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;下一篇</span></a>
            </li>
            <li class="next">
                <a href="https://mumulx.github.io/2020/03/nginx%E7%AC%94%E8%AE%B0/"
                    title="Nginx进阶学习笔记"><span>上一篇&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="文章目录" role="button">
                    <span>[&nbsp;</span><span>文章目录</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        
        <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal"
            data-target="#donateModal"><span>赏</span></button>
        
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>


<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content donate">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <div class="modal-body">
                <div class="donate-box">
                    <div class="donate-head">
                        <p>感谢您的支持,我会继续努力的!</p>
                    </div>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="alipay">
                            <div class="donate-payimg">
                                <img src="https://mumulx.github.io/donate/alipayimg.png"
                                    alt="扫码支持" title="扫一扫" />
                            </div>
                            <p class="text-muted mv">扫码打赏, 多少你说了算~</p>
                            <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦~</p>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="wechatpay">
                            <div class="donate-payimg">
                                <img src="https://mumulx.github.io/donate/wechatpayimg.png"
                                    alt="扫码支持" title="扫一扫" />
                            </div>
                            <p class="text-muted mv">扫码打赏, 多少你说了算~</p>
                            <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
                        </div>
                    </div>
                    <div class="donate-footer">
                        <ul class="nav nav-tabs nav-justified" role="tablist">
                            <li role="presentation" class="active">
                                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay"
                                    aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
                            </li>
                            <li role="presentation" class="">
                                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab"
                                    aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i>
                                    微信支付</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</main><footer class="footer" itemscope itemtype="https://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/mumulx" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://mumulx.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
    <li><a href="https://weibo.com/u/5459389722" target="_blank" title="weibo" data-toggle=tooltip data-placement=top >
            <i class="icon icon-weibo"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2019  -
    2020
    <div class="publishby">
        联系邮箱：<a target="_blank" title="木木的邮箱"> 1819778796@qq.com </a>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
   window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/rust.min.js"></script>
<script type="text/javascript"
   src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script>
hljs.configure({
  tabReplace: '    ', 
  classPrefix: ''     
                      
})
hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="https://mumulx.github.io/js/application.js"></script>
<script type="text/javascript" src="https://mumulx.github.io/js/plugin.js"></script>
<script>
      (function (window) {
          var INSIGHT_CONFIG = {
              TRANSLATION: {
                  POSTS: '文章',
                  PAGES: '页面',
                  CATEGORIES: '分类',
                  TAGS: '标签',
                  UNTITLED: '(未命名)',
              },
              ROOT_URL: 'https:\/\/mumulx.github.io\/',
              CONTENT_URL: 'https:\/\/mumulx.github.io\/\/searchindex.json ',
          };
          window.INSIGHT_CONFIG = INSIGHT_CONFIG;
      })(window);
      </script>
<script type="text/javascript" src="https://mumulx.github.io/js/insight.js"></script>


<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '1ccf8dc9e86b3575cfb2',
        clientSecret: '048ae422c4a6207a4e89c58ba1d4ebf820136bb0',
        repo: 'gittalk',
        owner: 'mumulx',
        admin: ['mumulx'],
        id: md5(location.pathname),
        distractionFreeMode: true
    });
    gitalk.render('comments');
</script>

  </body>
</html>
