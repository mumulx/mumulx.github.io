<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        GORM - 木木的个人博客
      </title>
    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  
  <meta name="theme-color" content="#000000" />
  
  <meta http-equiv="window-target" content="_top" />
  
  
  <meta name="description" content="GORM入门指南" />
  <meta name="generator" content="Hugo 0.59.1 with theme pure" />
  <title>GORM - 木木的个人博客</title>
  

  <link rel="stylesheet" href="https://mumulx.gitee.io/css/style.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css"> 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
  <meta property="og:title" content="GORM" />
<meta property="og:description" content="GORM入门指南" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mumulx.gitee.io/2022/10/gorm/" />
<meta property="article:published_time" content="2022-10-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-30T00:00:00+00:00" />

<meta itemprop="name" content="GORM">
<meta itemprop="description" content="GORM入门指南">


<meta itemprop="datePublished" content="2022-10-30T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-10-30T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="7278">



<meta itemprop="keywords" content="Golang," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GORM"/>
<meta name="twitter:description" content="GORM入门指南"/>

  <!--[if lte IE 9]>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
    <![endif]-->

  <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->

</head>
  </head>
  

  <body class="main-center" itemscope itemtype="https://schema.org/WebPage"><header class="header" itemscope itemtype="https://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://gitee.com/mumulx" target="_blank">
            <img class="img-circle img-rotate" src="https://mumulx.gitee.io/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">木木就是两个木</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">木木</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>xuzhou, China</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="想要查找什么..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="https://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">主页</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">归档</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">分类</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">标签</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">关于</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>
  <aside class="sidebar" itemscope itemtype="https://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p>我们的征途是星辰大海！</p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> 分类</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://mumulx.gitee.io/categories/golang/" class="category-list-link">golang</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://mumulx.gitee.io/categories/java%E9%9D%A2%E8%AF%95/" class="category-list-link">java面试</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://mumulx.gitee.io/categories/%E6%8A%80%E6%9C%AF%E6%94%B6%E5%BD%95/" class="category-list-link">技术收录</a><span class="category-list-count">36</span></li>
            <li class="category-list-item"><a href="https://mumulx.gitee.io/categories/%E6%8A%80%E6%9C%AF%E6%A1%86%E6%9E%B6/" class="category-list-link">技术框架</a><span class="category-list-count">17</span></li>
            <li class="category-list-item"><a href="https://mumulx.gitee.io/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" class="category-list-link">杂七杂八</a><span class="category-list-count">7</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> 标签</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/golang/" class="tag-list-link">golang</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/java/" class="tag-list-link">java</a><span
                    class="tag-list-count">10</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/java%E5%B9%B6%E5%8F%91/" class="tag-list-link">java并发</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/java%E5%BA%95%E5%B1%82/" class="tag-list-link">java底层</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/linux/" class="tag-list-link">linux</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/spring%E5%AE%B6%E6%97%8F/" class="tag-list-link">spring家族</a><span
                    class="tag-list-count">15</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="tag-list-link">中间件</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" class="tag-list-link">分布式</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" class="tag-list-link">前端框架</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="tag-list-link">开发工具</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="tag-list-link">数据库</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/" class="tag-list-link">杂七杂八</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E6%9D%83%E9%99%90/" class="tag-list-link">权限</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" class="tag-list-link">面试题</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://mumulx.gitee.io/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="tag-list-link">项目实战</a><span
                    class="tag-list-count">1</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.gitee.io/2022/10/gin/" class="title">Gin</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-10-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-10-30</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.gitee.io/2022/10/gorm/" class="title">GORM</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-10-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-10-30</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.gitee.io/2022/10/golang/" class="title">Golang</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-10-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-10-24</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.gitee.io/2022/06/springbatch/" class="title">SpringBatch中文文档</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-06-07 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-06-07</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://mumulx.gitee.io/2022/03/%E5%BE%AE%E5%89%8D%E7%AB%AFqiankun%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2/" class="title">微前端qiankun自动部署</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2022-03-10 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-03-10</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
  <aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="https://schema.org/WPSideBar">
    <div class="slimContent">
      <nav id="toc" class="article-toc">
        <h3 class="toc-title">文章目录</h3>
        <div class="toc-content always-active"><nav id="TableOfContents">
<ul>
<li><a href="#gorm入门指南">GORM入门指南</a>
<ul>
<li><a href="#gorm介绍">gorm介绍</a></li>
<li><a href="#安装">安装</a></li>
<li><a href="#连接数据库">连接数据库</a>
<ul>
<li><a href="#连接mysql">连接MySQL</a></li>
<li><a href="#连接postgresql">连接PostgreSQL</a></li>
<li><a href="#连接sqlite3">连接Sqlite3</a></li>
<li><a href="#连接sql-server">连接SQL Server</a></li>
</ul></li>
<li><a href="#gorm基本示例">GORM基本示例</a>
<ul>
<li><a href="#docker快速创建mysql实例">Docker快速创建MySQL实例</a></li>
<li><a href="#创建数据库">创建数据库</a></li>
<li><a href="#gorm操作mysql">GORM操作MySQL</a></li>
</ul></li>
<li><a href="#gorm-model定义">GORM Model定义</a>
<ul>
<li><a href="#gorm-model">gorm.Model</a></li>
<li><a href="#模型定义示例">模型定义示例</a></li>
<li><a href="#结构体标记-tags">结构体标记（tags）</a>
<ul>
<li><a href="#支持的结构体标记-struct-tags">支持的结构体标记（Struct tags）</a></li>
<li><a href="#关联相关标记-tags">关联相关标记（tags）</a></li>
</ul></li>
</ul></li>
<li><a href="#主键-表名-列名的约定">主键、表名、列名的约定</a>
<ul>
<li><a href="#主键-primary-key">主键（Primary Key）</a></li>
<li><a href="#表名-table-name">表名（Table Name）</a></li>
<li><a href="#列名-column-name">列名（Column Name）</a></li>
<li><a href="#时间戳跟踪">时间戳跟踪</a>
<ul>
<li><a href="#createdat">CreatedAt</a></li>
<li><a href="#updatedat">UpdatedAt</a></li>
<li><a href="#deletedat">DeletedAt</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#gorm-crud指南">GORM CRUD指南</a>
<ul>
<li><a href="#创建">创建</a>
<ul>
<li><a href="#创建记录">创建记录</a></li>
<li><a href="#默认值">默认值</a>
<ul>
<li><a href="#使用指针方式实现零值存入数据库">使用指针方式实现零值存入数据库</a></li>
<li><a href="#使用scanner-valuer接口方式实现零值存入数据库">使用Scanner/Valuer接口方式实现零值存入数据库</a></li>
</ul></li>
<li><a href="#扩展创建选项">扩展创建选项</a></li>
</ul></li>
<li><a href="#查询">查询</a>
<ul>
<li><a href="#一般查询">一般查询</a></li>
<li><a href="#where-条件">Where 条件</a>
<ul>
<li><a href="#普通sql查询">普通SQL查询</a></li>
<li><a href="#struct-map查询">Struct &amp; Map查询</a></li>
</ul></li>
<li><a href="#not-条件">Not 条件</a></li>
<li><a href="#or条件">Or条件</a></li>
<li><a href="#内联条件">内联条件</a></li>
<li><a href="#额外查询选项">额外查询选项</a></li>
<li><a href="#firstorinit">FirstOrInit</a>
<ul>
<li><a href="#attrs">Attrs</a></li>
<li><a href="#assign">Assign</a></li>
</ul></li>
<li><a href="#firstorcreate">FirstOrCreate</a>
<ul>
<li><a href="#attrs-1">Attrs</a></li>
<li><a href="#assign-1">Assign</a></li>
</ul></li>
<li><a href="#高级查询">高级查询</a>
<ul>
<li><a href="#子查询">子查询</a></li>
<li><a href="#选择字段">选择字段</a></li>
<li><a href="#排序">排序</a></li>
<li><a href="#数量">数量</a></li>
<li><a href="#偏移">偏移</a></li>
<li><a href="#总数">总数</a></li>
<li><a href="#group-having">Group &amp; Having</a></li>
<li><a href="#连接">连接</a></li>
</ul></li>
<li><a href="#pluck">Pluck</a></li>
<li><a href="#扫描">扫描</a></li>
</ul></li>
<li><a href="#链式操作相关">链式操作相关</a>
<ul>
<li><a href="#链式操作">链式操作</a></li>
<li><a href="#立即执行方法">立即执行方法</a></li>
<li><a href="#范围">范围</a></li>
<li><a href="#多个立即执行方法">多个立即执行方法</a></li>
</ul></li>
<li><a href="#更新">更新</a>
<ul>
<li><a href="#更新所有字段">更新所有字段</a></li>
<li><a href="#更新修改字段">更新修改字段</a></li>
<li><a href="#更新选定字段">更新选定字段</a></li>
<li><a href="#无hooks更新">无Hooks更新</a></li>
<li><a href="#批量更新">批量更新</a></li>
<li><a href="#使用sql表达式更新">使用SQL表达式更新</a></li>
<li><a href="#修改hooks中的值">修改Hooks中的值</a></li>
<li><a href="#其它更新选项">其它更新选项</a></li>
</ul></li>
<li><a href="#删除">删除</a>
<ul>
<li><a href="#删除记录">删除记录</a></li>
<li><a href="#批量删除">批量删除</a></li>
<li><a href="#软删除">软删除</a></li>
<li><a href="#物理删除">物理删除</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
        </div>
      </nav>
    </div>
  </aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="https://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2022/10/gorm/"
    >GORM</a
  >
</h1>

      <div class="article-meta">
        <span class="article-date">
  <i class="icon icon-calendar-check"></i>
<a href="https://mumulx.gitee.io/2022/10/gorm/" class="article-date">
  <time datetime="2022-10-30 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-10-30</time>
</a>
</span><span class="article-category">
  <i class="icon icon-folder"></i>
  <a class="article-category-link" href="/categories/golang/"> Golang </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>
    <a class="article-tag-link" href="/tags/golang/"> Golang </a>
  </span>

	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>
        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/10/gorm/#comments"
            class="article-comment-link">评论</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计:7278字</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长:15分 </span>
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      

<h1 id="gorm入门指南">GORM入门指南</h1>

<p>gorm是一个使用Go语言编写的ORM框架。它文档齐全，对开发者友好，支持主流数据库。</p>

<p>gorm官方中文文档：<a href="https://gorm.io/zh_CN/docs/">https://gorm.io/zh_CN/docs/</a></p>

<h2 id="gorm介绍">gorm介绍</h2>

<p><a href="https://github.com/jinzhu/gorm">Github GORM</a></p>

<p><a href="https://gorm.io/zh_CN/">中文官方网站</a>内含十分齐全的中文文档，有了它你甚至不需要再继续向下阅读本文。</p>

<h2 id="安装">安装</h2>

<pre><code class="language-bash">go get -u github.com/jinzhu/gorm
</code></pre>

<h2 id="连接数据库">连接数据库</h2>

<p>连接不同的数据库都需要导入对应数据的驱动程序，<code>GORM</code>已经贴心的为我们包装了一些驱动程序，只需要按如下方式导入需要的数据库驱动即可：</p>

<pre><code class="language-go">import _ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;
// import _ &quot;github.com/jinzhu/gorm/dialects/postgres&quot;
// import _ &quot;github.com/jinzhu/gorm/dialects/sqlite&quot;
// import _ &quot;github.com/jinzhu/gorm/dialects/mssql&quot;
</code></pre>

<h3 id="连接mysql">连接MySQL</h3>

<pre><code class="language-go">import (
  &quot;github.com/jinzhu/gorm&quot;
  _ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;
)

func main() {
  db, err := gorm.Open(&quot;mysql&quot;, &quot;user:password@(localhost)/dbname?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;)
  defer db.Close()
}
</code></pre>

<h3 id="连接postgresql">连接PostgreSQL</h3>

<p>基本代码同上，注意引入对应<code>postgres</code>驱动并正确指定<code>gorm.Open()</code>参数。</p>

<pre><code class="language-go">import (
  &quot;github.com/jinzhu/gorm&quot;
  _ &quot;github.com/jinzhu/gorm/dialects/postgres&quot;
)

func main() {
  db, err := gorm.Open(&quot;postgres&quot;, &quot;host=myhost port=myport user=gorm dbname=gorm password=mypassword&quot;)
  defer db.Close()
}
</code></pre>

<h3 id="连接sqlite3">连接Sqlite3</h3>

<p>基本代码同上，注意引入对应<code>sqlite</code>驱动并正确指定<code>gorm.Open()</code>参数。</p>

<pre><code class="language-go">import (
  &quot;github.com/jinzhu/gorm&quot;
  _ &quot;github.com/jinzhu/gorm/dialects/sqlite&quot;
)

func main() {
  db, err := gorm.Open(&quot;sqlite3&quot;, &quot;/tmp/gorm.db&quot;)
  defer db.Close()
}
</code></pre>

<h3 id="连接sql-server">连接SQL Server</h3>

<p>基本代码同上，注意引入对应<code>mssql</code>驱动并正确指定<code>gorm.Open()</code>参数。</p>

<pre><code class="language-go">import (
  &quot;github.com/jinzhu/gorm&quot;
  _ &quot;github.com/jinzhu/gorm/dialects/mssql&quot;
)

func main() {
  db, err := gorm.Open(&quot;mssql&quot;, &quot;sqlserver://username:password@localhost:1433?database=dbname&quot;)
  defer db.Close()
}
</code></pre>

<h2 id="gorm基本示例">GORM基本示例</h2>

<p><strong>注意:</strong></p>

<ol>
<li>本文以MySQL数据库为例，讲解GORM各项功能的主要使用方法。</li>
<li>往下阅读本文前，你需要有一个能够成功连接上的MySQL数据库实例。</li>
</ol>

<h3 id="docker快速创建mysql实例">Docker快速创建MySQL实例</h3>

<p>很多同学如果不会安装MySQL或者懒得安装MySQL，可以使用一下命令快速运行一个MySQL8.0.19实例，当然前提是你要有docker环境…</p>

<p>在本地的<code>13306</code>端口运行一个名为<code>mysql8019</code>，root用户名密码为<code>root1234</code>的MySQL容器环境:</p>

<pre><code class="language-bash">docker run --name mysql8019 -p 13306:3306 -e MYSQL_ROOT_PASSWORD=root1234 -d mysql:8.0.19
</code></pre>

<p>在另外启动一个<code>MySQL Client</code>连接上面的MySQL环境，密码为上一步指定的密码<code>root1234</code>:</p>

<pre><code class="language-bash">docker run -it --network host --rm mysql mysql -h127.0.0.1 -P13306 --default-character-set=utf8mb4 -uroot -p
</code></pre>

<h3 id="创建数据库">创建数据库</h3>

<p>在使用GORM前手动创建数据库<code>db1</code>：</p>

<pre><code class="language-mysql">CREATE DATABASE db1;
</code></pre>

<h3 id="gorm操作mysql">GORM操作MySQL</h3>

<p>使用GORM连接上面的<code>db1</code>进行创建、查询、更新、删除操作。</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;github.com/jinzhu/gorm&quot;
	_ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;
)

// UserInfo 用户信息
type UserInfo struct {
	ID uint
	Name string
	Gender string
	Hobby string
}


func main() {
	db, err := gorm.Open(&quot;mysql&quot;, &quot;root:root1234@(127.0.0.1:13306)/db1?charset=utf8mb4&amp;parseTime=True&amp;loc=Local&quot;)
	if err!= nil{
		panic(err)
	}
	defer db.Close()

	// 自动迁移
	db.AutoMigrate(&amp;UserInfo{})

	u1 := UserInfo{1, &quot;七米&quot;, &quot;男&quot;, &quot;篮球&quot;}
	u2 := UserInfo{2, &quot;沙河娜扎&quot;, &quot;女&quot;, &quot;足球&quot;}
	// 创建记录
	db.Create(&amp;u1)
	db.Create(&amp;u2)
	// 查询
	var u = new(UserInfo)
	db.First(u)
	fmt.Printf(&quot;%#v\n&quot;, u)

	var uu UserInfo
	db.Find(&amp;uu, &quot;hobby=?&quot;, &quot;足球&quot;)
	fmt.Printf(&quot;%#v\n&quot;, uu)

	// 更新
	db.Model(&amp;u).Update(&quot;hobby&quot;, &quot;双色球&quot;)
	// 删除
	db.Delete(&amp;u)
}
</code></pre>

<h2 id="gorm-model定义">GORM Model定义</h2>

<p>在使用ORM工具时，通常我们需要在代码中定义模型（Models）与数据库中的数据表进行映射，在GORM中模型（Models）通常是正常定义的结构体、基本的go类型或它们的指针。 同时也支持<code>sql.Scanner</code>及<code>driver.Valuer</code>接口（interfaces）。</p>

<h3 id="gorm-model">gorm.Model</h3>

<p>为了方便模型定义，GORM内置了一个<code>gorm.Model</code>结构体。<code>gorm.Model</code>是一个包含了<code>ID</code>, <code>CreatedAt</code>, <code>UpdatedAt</code>, <code>DeletedAt</code>四个字段的Golang结构体。</p>

<pre><code class="language-go">// gorm.Model 定义
type Model struct {
  ID        uint `gorm:&quot;primary_key&quot;`
  CreatedAt time.Time
  UpdatedAt time.Time
  DeletedAt *time.Time
}
</code></pre>

<p>你可以将它嵌入到你自己的模型中：</p>

<pre><code class="language-go">// 将 `ID`, `CreatedAt`, `UpdatedAt`, `DeletedAt`字段注入到`User`模型中
type User struct {
  gorm.Model
  Name string
}
</code></pre>

<p>当然你也可以完全自己定义模型：</p>

<pre><code class="language-go">// 不使用gorm.Model，自行定义模型
type User struct {
  ID   int
  Name string
}
</code></pre>

<h3 id="模型定义示例">模型定义示例</h3>

<pre><code class="language-go">type User struct {
  gorm.Model
  Name         string
  Age          sql.NullInt64
  Birthday     *time.Time
  Email        string  `gorm:&quot;type:varchar(100);unique_index&quot;`
  Role         string  `gorm:&quot;size:255&quot;` // 设置字段大小为255
  MemberNumber *string `gorm:&quot;unique;not null&quot;` // 设置会员号（member number）唯一并且不为空
  Num          int     `gorm:&quot;AUTO_INCREMENT&quot;` // 设置 num 为自增类型
  Address      string  `gorm:&quot;index:addr&quot;` // 给address字段创建名为addr的索引
  IgnoreMe     int     `gorm:&quot;-&quot;` // 忽略本字段
}
</code></pre>

<h3 id="结构体标记-tags">结构体标记（tags）</h3>

<p>使用结构体声明模型时，标记（tags）是可选项。gorm支持以下标记:</p>

<h4 id="支持的结构体标记-struct-tags">支持的结构体标记（Struct tags）</h4>

<table>
<thead>
<tr>
<th align="center">结构体标记（Tag）</th>
<th align="center">描述</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">Column</td>
<td align="center">指定列名</td>
</tr>

<tr>
<td align="center">Type</td>
<td align="center">指定列数据类型</td>
</tr>

<tr>
<td align="center">Size</td>
<td align="center">指定列大小, 默认值255</td>
</tr>

<tr>
<td align="center">PRIMARY_KEY</td>
<td align="center">将列指定为主键</td>
</tr>

<tr>
<td align="center">UNIQUE</td>
<td align="center">将列指定为唯一</td>
</tr>

<tr>
<td align="center">DEFAULT</td>
<td align="center">指定列默认值</td>
</tr>

<tr>
<td align="center">PRECISION</td>
<td align="center">指定列精度</td>
</tr>

<tr>
<td align="center">NOT NULL</td>
<td align="center">将列指定为非 NULL</td>
</tr>

<tr>
<td align="center">AUTO_INCREMENT</td>
<td align="center">指定列是否为自增类型</td>
</tr>

<tr>
<td align="center">INDEX</td>
<td align="center">创建具有或不带名称的索引, 如果多个索引同名则创建复合索引</td>
</tr>

<tr>
<td align="center">UNIQUE_INDEX</td>
<td align="center">和 <code>INDEX</code> 类似，只不过创建的是唯一索引</td>
</tr>

<tr>
<td align="center">EMBEDDED</td>
<td align="center">将结构设置为嵌入</td>
</tr>

<tr>
<td align="center">EMBEDDED_PREFIX</td>
<td align="center">设置嵌入结构的前缀</td>
</tr>

<tr>
<td align="center">-</td>
<td align="center">忽略此字段</td>
</tr>
</tbody>
</table>

<h4 id="关联相关标记-tags">关联相关标记（tags）</h4>

<table>
<thead>
<tr>
<th align="center">结构体标记（Tag）</th>
<th align="center">描述</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center">MANY2MANY</td>
<td align="center">指定连接表</td>
</tr>

<tr>
<td align="center">FOREIGNKEY</td>
<td align="center">设置外键</td>
</tr>

<tr>
<td align="center">ASSOCIATION_FOREIGNKEY</td>
<td align="center">设置关联外键</td>
</tr>

<tr>
<td align="center">POLYMORPHIC</td>
<td align="center">指定多态类型</td>
</tr>

<tr>
<td align="center">POLYMORPHIC_VALUE</td>
<td align="center">指定多态值</td>
</tr>

<tr>
<td align="center">JOINTABLE_FOREIGNKEY</td>
<td align="center">指定连接表的外键</td>
</tr>

<tr>
<td align="center">ASSOCIATION_JOINTABLE_FOREIGNKEY</td>
<td align="center">指定连接表的关联外键</td>
</tr>

<tr>
<td align="center">SAVE_ASSOCIATIONS</td>
<td align="center">是否自动完成 save 的相关操作</td>
</tr>

<tr>
<td align="center">ASSOCIATION_AUTOUPDATE</td>
<td align="center">是否自动完成 update 的相关操作</td>
</tr>

<tr>
<td align="center">ASSOCIATION_AUTOCREATE</td>
<td align="center">是否自动完成 create 的相关操作</td>
</tr>

<tr>
<td align="center">ASSOCIATION_SAVE_REFERENCE</td>
<td align="center">是否自动完成引用的 save 的相关操作</td>
</tr>

<tr>
<td align="center">PRELOAD</td>
<td align="center">是否自动完成预加载的相关操作</td>
</tr>
</tbody>
</table>

<h2 id="主键-表名-列名的约定">主键、表名、列名的约定</h2>

<h3 id="主键-primary-key">主键（Primary Key）</h3>

<p>GORM 默认会使用名为ID的字段作为表的主键。</p>

<pre><code class="language-go">type User struct {
  ID   string // 名为`ID`的字段会默认作为表的主键
  Name string
}

// 使用`AnimalID`作为主键
type Animal struct {
  AnimalID int64 `gorm:&quot;primary_key&quot;`
  Name     string
  Age      int64
}
</code></pre>

<h3 id="表名-table-name">表名（Table Name）</h3>

<p>表名默认就是结构体名称的复数，例如：</p>

<pre><code class="language-go">type User struct {} // 默认表名是 `users`

// 将 User 的表名设置为 `profiles`
func (User) TableName() string {
  return &quot;profiles&quot;
}

func (u User) TableName() string {
  if u.Role == &quot;admin&quot; {
    return &quot;admin_users&quot;
  } else {
    return &quot;users&quot;
  }
}

// 禁用默认表名的复数形式，如果置为 true，则 `User` 的默认表名是 `user`
db.SingularTable(true)
</code></pre>

<p>也可以通过<code>Table()</code>指定表名：</p>

<pre><code class="language-go">// 使用User结构体创建名为`deleted_users`的表
db.Table(&quot;deleted_users&quot;).CreateTable(&amp;User{})

var deleted_users []User
db.Table(&quot;deleted_users&quot;).Find(&amp;deleted_users)
//// SELECT * FROM deleted_users;

db.Table(&quot;deleted_users&quot;).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Delete()
//// DELETE FROM deleted_users WHERE name = 'jinzhu';
</code></pre>

<p>GORM还支持更改默认表名称规则：</p>

<pre><code class="language-go">gorm.DefaultTableNameHandler = func (db *gorm.DB, defaultTableName string) string  {
  return &quot;prefix_&quot; + defaultTableName;
}
</code></pre>

<h3 id="列名-column-name">列名（Column Name）</h3>

<p>列名由字段名称进行下划线分割来生成</p>

<pre><code class="language-go">type User struct {
  ID        uint      // column name is `id`
  Name      string    // column name is `name`
  Birthday  time.Time // column name is `birthday`
  CreatedAt time.Time // column name is `created_at`
}
</code></pre>

<p>可以使用结构体tag指定列名：</p>

<pre><code class="language-go">type Animal struct {
  AnimalId    int64     `gorm:&quot;column:beast_id&quot;`         // set column name to `beast_id`
  Birthday    time.Time `gorm:&quot;column:day_of_the_beast&quot;` // set column name to `day_of_the_beast`
  Age         int64     `gorm:&quot;column:age_of_the_beast&quot;` // set column name to `age_of_the_beast`
}
</code></pre>

<h3 id="时间戳跟踪">时间戳跟踪</h3>

<h4 id="createdat">CreatedAt</h4>

<p>如果模型有 <code>CreatedAt</code>字段，该字段的值将会是初次创建记录的时间。</p>

<pre><code class="language-go">db.Create(&amp;user) // `CreatedAt`将会是当前时间

// 可以使用`Update`方法来改变`CreateAt`的值
db.Model(&amp;user).Update(&quot;CreatedAt&quot;, time.Now())
</code></pre>

<h4 id="updatedat">UpdatedAt</h4>

<p>如果模型有<code>UpdatedAt</code>字段，该字段的值将会是每次更新记录的时间。</p>

<pre><code class="language-go">db.Save(&amp;user) // `UpdatedAt`将会是当前时间

db.Model(&amp;user).Update(&quot;name&quot;, &quot;jinzhu&quot;) // `UpdatedAt`将会是当前时间
</code></pre>

<h4 id="deletedat">DeletedAt</h4>

<p>如果模型有<code>DeletedAt</code>字段，调用<code>Delete</code>删除该记录时，将会设置<code>DeletedAt</code>字段为当前时间，而不是直接将记录从数据库中删除。</p>

<hr />

<h1 id="gorm-crud指南">GORM CRUD指南</h1>

<p>CRUD通常指数据库的增删改查操作，本文详细介绍了如何使用GORM实现创建、查询、更新和删除操作。</p>

<p>gorm官方中文文档：<a href="https://gorm.io/zh_CN/docs/">https://gorm.io/zh_CN/docs/</a></p>

<p><strong>CRUD</strong></p>

<p>CRUD通常指数据库的增删改查操作，本文详细介绍了如何使用GORM实现创建、查询、更新和删除操作。</p>

<p>本文中的<code>db</code>变量为<code>*gorm.DB</code>对象，例如：</p>

<pre><code class="language-go">import (
  &quot;github.com/jinzhu/gorm&quot;
  _ &quot;github.com/jinzhu/gorm/dialects/mysql&quot;
)

func main() {
  db, err := gorm.Open(&quot;mysql&quot;, &quot;user:password@/dbname?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;)
  defer db.Close()
  
  // db.Xx
}
</code></pre>

<h2 id="创建">创建</h2>

<h3 id="创建记录">创建记录</h3>

<p>首先定义模型：</p>

<pre><code class="language-go">type User struct {
	ID           int64
	Name         string
	Age          int64
}
</code></pre>

<p>使用使用<code>NewRecord()</code>查询主键是否存在，主键为空使用<code>Create()</code>创建记录：</p>

<pre><code class="language-go">user := User{Name: &quot;q1mi&quot;, Age: 18}

db.NewRecord(user) // 主键为空返回`true`
db.Create(&amp;user)   // 创建user
db.NewRecord(user) // 创建`user`后返回`false`
</code></pre>

<h3 id="默认值">默认值</h3>

<p>可以通过 tag 定义字段的默认值，比如：</p>

<pre><code class="language-go">type User struct {
  ID   int64
  Name string `gorm:&quot;default:'小王子'&quot;`
  Age  int64
}
</code></pre>

<p><strong>注意：</strong>通过tag定义字段的默认值，在创建记录时候生成的 SQL 语句会排除没有值或值为 零值 的字段。 在将记录插入到数据库后，Gorm会从数据库加载那些字段的默认值。</p>

<p>举个例子：</p>

<pre><code class="language-go">var user = User{Name: &quot;&quot;, Age: 99}
db.Create(&amp;user)
</code></pre>

<p>上面代码实际执行的SQL语句是<code>INSERT INTO users(&quot;age&quot;) values('99');</code>，排除了零值字段<code>Name</code>，而在数据库中这一条数据会使用设置的默认值<code>小王子</code>作为Name字段的值。</p>

<p><strong>注意：</strong>所有字段的零值, 比如<code>0</code>, <code>&quot;&quot;</code>,<code>false</code>或者其它<code>零值</code>，都不会保存到数据库内，但会使用他们的默认值。 如果你想避免这种情况，可以考虑使用指针或实现 <code>Scanner/Valuer</code>接口，比如：</p>

<h4 id="使用指针方式实现零值存入数据库">使用指针方式实现零值存入数据库</h4>

<pre><code class="language-go">// 使用指针
type User struct {
  ID   int64
  Name *string `gorm:&quot;default:'小王子'&quot;`
  Age  int64
}
user := User{Name: new(string), Age: 18))}
db.Create(&amp;user)  // 此时数据库中该条记录name字段的值就是''
</code></pre>

<h4 id="使用scanner-valuer接口方式实现零值存入数据库">使用Scanner/Valuer接口方式实现零值存入数据库</h4>

<pre><code class="language-go">// 使用 Scanner/Valuer
type User struct {
	ID int64
	Name sql.NullString `gorm:&quot;default:'小王子'&quot;` // sql.NullString 实现了Scanner/Valuer接口
	Age  int64
}
user := User{Name: sql.NullString{&quot;&quot;, true}, Age:18}
db.Create(&amp;user)  // 此时数据库中该条记录name字段的值就是''
</code></pre>

<h3 id="扩展创建选项">扩展创建选项</h3>

<p>例如<code>PostgreSQL</code>数据库中可以使用下面的方式实现合并插入, 有则更新, 无则插入。</p>

<pre><code class="language-go">// 为Instert语句添加扩展SQL选项
db.Set(&quot;gorm:insert_option&quot;, &quot;ON CONFLICT&quot;).Create(&amp;product)
// INSERT INTO products (name, code) VALUES (&quot;name&quot;, &quot;code&quot;) ON CONFLICT;
</code></pre>

<h2 id="查询">查询</h2>

<h3 id="一般查询">一般查询</h3>

<pre><code class="language-go">// 根据主键查询第一条记录
db.First(&amp;user)
//// SELECT * FROM users ORDER BY id LIMIT 1;

// 随机获取一条记录
db.Take(&amp;user)
//// SELECT * FROM users LIMIT 1;

// 根据主键查询最后一条记录
db.Last(&amp;user)
//// SELECT * FROM users ORDER BY id DESC LIMIT 1;

// 查询所有的记录
db.Find(&amp;users)
//// SELECT * FROM users;

// 查询指定的某条记录(仅当主键为整型时可用)
db.First(&amp;user, 10)
//// SELECT * FROM users WHERE id = 10;
</code></pre>

<h3 id="where-条件">Where 条件</h3>

<h4 id="普通sql查询">普通SQL查询</h4>

<pre><code class="language-go">// Get first matched record
db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user)
//// SELECT * FROM users WHERE name = 'jinzhu' limit 1;

// Get all matched records
db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE name = 'jinzhu';

// &lt;&gt;
db.Where(&quot;name &lt;&gt; ?&quot;, &quot;jinzhu&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE name &lt;&gt; 'jinzhu';

// IN
db.Where(&quot;name IN (?)&quot;, []string{&quot;jinzhu&quot;, &quot;jinzhu 2&quot;}).Find(&amp;users)
//// SELECT * FROM users WHERE name in ('jinzhu','jinzhu 2');

// LIKE
db.Where(&quot;name LIKE ?&quot;, &quot;%jin%&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE name LIKE '%jin%';

// AND
db.Where(&quot;name = ? AND age &gt;= ?&quot;, &quot;jinzhu&quot;, &quot;22&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE name = 'jinzhu' AND age &gt;= 22;

// Time
db.Where(&quot;updated_at &gt; ?&quot;, lastWeek).Find(&amp;users)
//// SELECT * FROM users WHERE updated_at &gt; '2000-01-01 00:00:00';

// BETWEEN
db.Where(&quot;created_at BETWEEN ? AND ?&quot;, lastWeek, today).Find(&amp;users)
//// SELECT * FROM users WHERE created_at BETWEEN '2000-01-01 00:00:00' AND '2000-01-08 00:00:00';
</code></pre>

<h4 id="struct-map查询">Struct &amp; Map查询</h4>

<pre><code class="language-go">// Struct
db.Where(&amp;User{Name: &quot;jinzhu&quot;, Age: 20}).First(&amp;user)
//// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20 LIMIT 1;

// Map
db.Where(map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;, &quot;age&quot;: 20}).Find(&amp;users)
//// SELECT * FROM users WHERE name = &quot;jinzhu&quot; AND age = 20;

// 主键的切片
db.Where([]int64{20, 21, 22}).Find(&amp;users)
//// SELECT * FROM users WHERE id IN (20, 21, 22);
</code></pre>

<p><strong>提示：</strong>当通过结构体进行查询时，GORM将会只通过非零值字段查询，这意味着如果你的字段值为<code>0</code>，<code>''</code>，<code>false</code>或者其他<code>零值</code>时，将不会被用于构建查询条件，例如：</p>

<pre><code class="language-go">db.Where(&amp;User{Name: &quot;jinzhu&quot;, Age: 0}).Find(&amp;users)
//// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;
</code></pre>

<p>你可以使用指针或实现 Scanner/Valuer 接口来避免这个问题.</p>

<pre><code class="language-go">// 使用指针
type User struct {
  gorm.Model
  Name string
  Age  *int
}

// 使用 Scanner/Valuer
type User struct {
  gorm.Model
  Name string
  Age  sql.NullInt64  // sql.NullInt64 实现了 Scanner/Valuer 接口
}
</code></pre>

<h3 id="not-条件">Not 条件</h3>

<p>作用与 Where 类似的情形如下：</p>

<pre><code class="language-go">db.Not(&quot;name&quot;, &quot;jinzhu&quot;).First(&amp;user)
//// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; LIMIT 1;

// Not In
db.Not(&quot;name&quot;, []string{&quot;jinzhu&quot;, &quot;jinzhu 2&quot;}).Find(&amp;users)
//// SELECT * FROM users WHERE name NOT IN (&quot;jinzhu&quot;, &quot;jinzhu 2&quot;);

// Not In slice of primary keys
db.Not([]int64{1,2,3}).First(&amp;user)
//// SELECT * FROM users WHERE id NOT IN (1,2,3);

db.Not([]int64{}).First(&amp;user)
//// SELECT * FROM users;

// Plain SQL
db.Not(&quot;name = ?&quot;, &quot;jinzhu&quot;).First(&amp;user)
//// SELECT * FROM users WHERE NOT(name = &quot;jinzhu&quot;);

// Struct
db.Not(User{Name: &quot;jinzhu&quot;}).First(&amp;user)
//// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot;;
</code></pre>

<h3 id="or条件">Or条件</h3>

<pre><code class="language-go">db.Where(&quot;role = ?&quot;, &quot;admin&quot;).Or(&quot;role = ?&quot;, &quot;super_admin&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE role = 'admin' OR role = 'super_admin';

// Struct
db.Where(&quot;name = 'jinzhu'&quot;).Or(User{Name: &quot;jinzhu 2&quot;}).Find(&amp;users)
//// SELECT * FROM users WHERE name = 'jinzhu' OR name = 'jinzhu 2';

// Map
db.Where(&quot;name = 'jinzhu'&quot;).Or(map[string]interface{}{&quot;name&quot;: &quot;jinzhu 2&quot;}).Find(&amp;users)
//// SELECT * FROM users WHERE name = 'jinzhu' OR name = 'jinzhu 2';
</code></pre>

<h3 id="内联条件">内联条件</h3>

<p>作用与<code>Where</code>查询类似，当内联条件与多个<a href="https://www.liwenzhou.com/posts/Go/gorm_crud/#autoid-1-3-1">立即执行方法</a>一起使用时, 内联条件不会传递给后面的立即执行方法。</p>

<pre><code class="language-go">// 根据主键获取记录 (只适用于整形主键)
db.First(&amp;user, 23)
//// SELECT * FROM users WHERE id = 23 LIMIT 1;
// 根据主键获取记录, 如果它是一个非整形主键
db.First(&amp;user, &quot;id = ?&quot;, &quot;string_primary_key&quot;)
//// SELECT * FROM users WHERE id = 'string_primary_key' LIMIT 1;

// Plain SQL
db.Find(&amp;user, &quot;name = ?&quot;, &quot;jinzhu&quot;)
//// SELECT * FROM users WHERE name = &quot;jinzhu&quot;;

db.Find(&amp;users, &quot;name &lt;&gt; ? AND age &gt; ?&quot;, &quot;jinzhu&quot;, 20)
//// SELECT * FROM users WHERE name &lt;&gt; &quot;jinzhu&quot; AND age &gt; 20;

// Struct
db.Find(&amp;users, User{Age: 20})
//// SELECT * FROM users WHERE age = 20;

// Map
db.Find(&amp;users, map[string]interface{}{&quot;age&quot;: 20})
//// SELECT * FROM users WHERE age = 20;
</code></pre>

<h3 id="额外查询选项">额外查询选项</h3>

<pre><code class="language-go">// 为查询 SQL 添加额外的 SQL 操作
db.Set(&quot;gorm:query_option&quot;, &quot;FOR UPDATE&quot;).First(&amp;user, 10)
//// SELECT * FROM users WHERE id = 10 FOR UPDATE;
</code></pre>

<h3 id="firstorinit">FirstOrInit</h3>

<p>获取匹配的第一条记录，否则根据给定的条件初始化一个新的对象 (仅支持 struct 和 map 条件)</p>

<pre><code class="language-go">// 未找到
db.FirstOrInit(&amp;user, User{Name: &quot;non_existing&quot;})
//// user -&gt; User{Name: &quot;non_existing&quot;}

// 找到
db.Where(User{Name: &quot;Jinzhu&quot;}).FirstOrInit(&amp;user)
//// user -&gt; User{Id: 111, Name: &quot;Jinzhu&quot;, Age: 20}
db.FirstOrInit(&amp;user, map[string]interface{}{&quot;name&quot;: &quot;jinzhu&quot;})
//// user -&gt; User{Id: 111, Name: &quot;Jinzhu&quot;, Age: 20}
</code></pre>

<h4 id="attrs">Attrs</h4>

<p>如果记录未找到，将使用参数初始化 struct.</p>

<pre><code class="language-go">// 未找到
db.Where(User{Name: &quot;non_existing&quot;}).Attrs(User{Age: 20}).FirstOrInit(&amp;user)
//// SELECT * FROM USERS WHERE name = 'non_existing';
//// user -&gt; User{Name: &quot;non_existing&quot;, Age: 20}

db.Where(User{Name: &quot;non_existing&quot;}).Attrs(&quot;age&quot;, 20).FirstOrInit(&amp;user)
//// SELECT * FROM USERS WHERE name = 'non_existing';
//// user -&gt; User{Name: &quot;non_existing&quot;, Age: 20}

// 找到
db.Where(User{Name: &quot;Jinzhu&quot;}).Attrs(User{Age: 30}).FirstOrInit(&amp;user)
//// SELECT * FROM USERS WHERE name = jinzhu';
//// user -&gt; User{Id: 111, Name: &quot;Jinzhu&quot;, Age: 20}
</code></pre>

<h4 id="assign">Assign</h4>

<p>不管记录是否找到，都将参数赋值给 struct.</p>

<pre><code class="language-go">// 未找到
db.Where(User{Name: &quot;non_existing&quot;}).Assign(User{Age: 20}).FirstOrInit(&amp;user)
//// user -&gt; User{Name: &quot;non_existing&quot;, Age: 20}

// 找到
db.Where(User{Name: &quot;Jinzhu&quot;}).Assign(User{Age: 30}).FirstOrInit(&amp;user)
//// SELECT * FROM USERS WHERE name = jinzhu';
//// user -&gt; User{Id: 111, Name: &quot;Jinzhu&quot;, Age: 30}
</code></pre>

<h3 id="firstorcreate">FirstOrCreate</h3>

<p>获取匹配的第一条记录, 否则根据给定的条件创建一个新的记录 (仅支持 struct 和 map 条件)</p>

<pre><code class="language-go">// 未找到
db.FirstOrCreate(&amp;user, User{Name: &quot;non_existing&quot;})
//// INSERT INTO &quot;users&quot; (name) VALUES (&quot;non_existing&quot;);
//// user -&gt; User{Id: 112, Name: &quot;non_existing&quot;}

// 找到
db.Where(User{Name: &quot;Jinzhu&quot;}).FirstOrCreate(&amp;user)
//// user -&gt; User{Id: 111, Name: &quot;Jinzhu&quot;}
</code></pre>

<h4 id="attrs-1">Attrs</h4>

<p>如果记录未找到，将使用参数创建 struct 和记录.</p>

<pre><code class="language-go"> // 未找到
db.Where(User{Name: &quot;non_existing&quot;}).Attrs(User{Age: 20}).FirstOrCreate(&amp;user)
//// SELECT * FROM users WHERE name = 'non_existing';
//// INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);
//// user -&gt; User{Id: 112, Name: &quot;non_existing&quot;, Age: 20}

// 找到
db.Where(User{Name: &quot;jinzhu&quot;}).Attrs(User{Age: 30}).FirstOrCreate(&amp;user)
//// SELECT * FROM users WHERE name = 'jinzhu';
//// user -&gt; User{Id: 111, Name: &quot;jinzhu&quot;, Age: 20}
</code></pre>

<h4 id="assign-1">Assign</h4>

<p>不管记录是否找到，都将参数赋值给 struct 并保存至数据库.</p>

<pre><code class="language-go">// 未找到
db.Where(User{Name: &quot;non_existing&quot;}).Assign(User{Age: 20}).FirstOrCreate(&amp;user)
//// SELECT * FROM users WHERE name = 'non_existing';
//// INSERT INTO &quot;users&quot; (name, age) VALUES (&quot;non_existing&quot;, 20);
//// user -&gt; User{Id: 112, Name: &quot;non_existing&quot;, Age: 20}

// 找到
db.Where(User{Name: &quot;jinzhu&quot;}).Assign(User{Age: 30}).FirstOrCreate(&amp;user)
//// SELECT * FROM users WHERE name = 'jinzhu';
//// UPDATE users SET age=30 WHERE id = 111;
//// user -&gt; User{Id: 111, Name: &quot;jinzhu&quot;, Age: 30}
</code></pre>

<h3 id="高级查询">高级查询</h3>

<h4 id="子查询">子查询</h4>

<p>基于 <code>*gorm.expr</code> 的子查询</p>

<pre><code class="language-go">db.Where(&quot;amount &gt; ?&quot;, db.Table(&quot;orders&quot;).Select(&quot;AVG(amount)&quot;).Where(&quot;state = ?&quot;, &quot;paid&quot;).SubQuery()).Find(&amp;orders)
// SELECT * FROM &quot;orders&quot;  WHERE &quot;orders&quot;.&quot;deleted_at&quot; IS NULL AND (amount &gt; (SELECT AVG(amount) FROM &quot;orders&quot;  WHERE (state = 'paid')));
</code></pre>

<h4 id="选择字段">选择字段</h4>

<p>Select，指定你想从数据库中检索出的字段，默认会选择全部字段。</p>

<pre><code class="language-go">db.Select(&quot;name, age&quot;).Find(&amp;users)
//// SELECT name, age FROM users;

db.Select([]string{&quot;name&quot;, &quot;age&quot;}).Find(&amp;users)
//// SELECT name, age FROM users;

db.Table(&quot;users&quot;).Select(&quot;COALESCE(age,?)&quot;, 42).Rows()
//// SELECT COALESCE(age,'42') FROM users;
</code></pre>

<h4 id="排序">排序</h4>

<p>Order，指定从数据库中检索出记录的顺序。设置第二个参数 reorder 为 <code>true</code> ，可以覆盖前面定义的排序条件。</p>

<pre><code class="language-go">db.Order(&quot;age desc, name&quot;).Find(&amp;users)
//// SELECT * FROM users ORDER BY age desc, name;

// 多字段排序
db.Order(&quot;age desc&quot;).Order(&quot;name&quot;).Find(&amp;users)
//// SELECT * FROM users ORDER BY age desc, name;

// 覆盖排序
db.Order(&quot;age desc&quot;).Find(&amp;users1).Order(&quot;age&quot;, true).Find(&amp;users2)
//// SELECT * FROM users ORDER BY age desc; (users1)
//// SELECT * FROM users ORDER BY age; (users2)
</code></pre>

<h4 id="数量">数量</h4>

<p>Limit，指定从数据库检索出的最大记录数。</p>

<pre><code class="language-go">db.Limit(3).Find(&amp;users)
//// SELECT * FROM users LIMIT 3;

// -1 取消 Limit 条件
db.Limit(10).Find(&amp;users1).Limit(-1).Find(&amp;users2)
//// SELECT * FROM users LIMIT 10; (users1)
//// SELECT * FROM users; (users2)
</code></pre>

<h4 id="偏移">偏移</h4>

<p>Offset，指定开始返回记录前要跳过的记录数。</p>

<pre><code class="language-go">db.Offset(3).Find(&amp;users)
//// SELECT * FROM users OFFSET 3;

// -1 取消 Offset 条件
db.Offset(10).Find(&amp;users1).Offset(-1).Find(&amp;users2)
//// SELECT * FROM users OFFSET 10; (users1)
//// SELECT * FROM users; (users2)
</code></pre>

<h4 id="总数">总数</h4>

<p>Count，该 model 能获取的记录总数。</p>

<pre><code class="language-go">db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Or(&quot;name = ?&quot;, &quot;jinzhu 2&quot;).Find(&amp;users).Count(&amp;count)
//// SELECT * from USERS WHERE name = 'jinzhu' OR name = 'jinzhu 2'; (users)
//// SELECT count(*) FROM users WHERE name = 'jinzhu' OR name = 'jinzhu 2'; (count)

db.Model(&amp;User{}).Where(&quot;name = ?&quot;, &quot;jinzhu&quot;).Count(&amp;count)
//// SELECT count(*) FROM users WHERE name = 'jinzhu'; (count)

db.Table(&quot;deleted_users&quot;).Count(&amp;count)
//// SELECT count(*) FROM deleted_users;

db.Table(&quot;deleted_users&quot;).Select(&quot;count(distinct(name))&quot;).Count(&amp;count)
//// SELECT count( distinct(name) ) FROM deleted_users; (count)
</code></pre>

<p><strong>注意</strong> <code>Count</code> 必须是链式查询的最后一个操作 ，因为它会覆盖前面的 <code>SELECT</code>，但如果里面使用了 <code>count</code> 时不会覆盖</p>

<h4 id="group-having">Group &amp; Having</h4>

<pre><code class="language-go">rows, err := db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Rows()
for rows.Next() {
  ...
}

// 使用Scan将多条结果扫描进事先准备好的结构体切片中
type Result struct {
	Date time.Time
	Total int
}
var rets []Result
db.Table(&quot;users&quot;).Select(&quot;date(created_at) as date, sum(age) as total&quot;).Group(&quot;date(created_at)&quot;).Scan(&amp;rets)

rows, err := db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Having(&quot;sum(amount) &gt; ?&quot;, 100).Rows()
for rows.Next() {
  ...
}

type Result struct {
  Date  time.Time
  Total int64
}
db.Table(&quot;orders&quot;).Select(&quot;date(created_at) as date, sum(amount) as total&quot;).Group(&quot;date(created_at)&quot;).Having(&quot;sum(amount) &gt; ?&quot;, 100).Scan(&amp;results)
</code></pre>

<h4 id="连接">连接</h4>

<p>Joins，指定连接条件</p>

<pre><code class="language-go">rows, err := db.Table(&quot;users&quot;).Select(&quot;users.name, emails.email&quot;).Joins(&quot;left join emails on emails.user_id = users.id&quot;).Rows()
for rows.Next() {
  ...
}

db.Table(&quot;users&quot;).Select(&quot;users.name, emails.email&quot;).Joins(&quot;left join emails on emails.user_id = users.id&quot;).Scan(&amp;results)

// 多连接及参数
db.Joins(&quot;JOIN emails ON emails.user_id = users.id AND emails.email = ?&quot;, &quot;jinzhu@example.org&quot;).Joins(&quot;JOIN credit_cards ON credit_cards.user_id = users.id&quot;).Where(&quot;credit_cards.number = ?&quot;, &quot;411111111111&quot;).Find(&amp;user)
</code></pre>

<h3 id="pluck">Pluck</h3>

<p>Pluck，查询 model 中的一个列作为切片，如果您想要查询多个列，您应该使用 <a href="https://www.liwenzhou.com/posts/Go/gorm_crud/#Scan"><code>Scan</code></a></p>

<pre><code class="language-go">var ages []int64
db.Find(&amp;users).Pluck(&quot;age&quot;, &amp;ages)

var names []string
db.Model(&amp;User{}).Pluck(&quot;name&quot;, &amp;names)

db.Table(&quot;deleted_users&quot;).Pluck(&quot;name&quot;, &amp;names)

// 想查询多个字段？ 这样做：
db.Select(&quot;name, age&quot;).Find(&amp;users)
</code></pre>

<h3 id="扫描">扫描</h3>

<p>Scan，扫描结果至一个 struct.</p>

<pre><code class="language-go">type Result struct {
  Name string
  Age  int
}

var result Result
db.Table(&quot;users&quot;).Select(&quot;name, age&quot;).Where(&quot;name = ?&quot;, &quot;Antonio&quot;).Scan(&amp;result)

var results []Result
db.Table(&quot;users&quot;).Select(&quot;name, age&quot;).Where(&quot;id &gt; ?&quot;, 0).Scan(&amp;results)

// 原生 SQL
db.Raw(&quot;SELECT name, age FROM users WHERE name = ?&quot;, &quot;Antonio&quot;).Scan(&amp;result)
</code></pre>

<h2 id="链式操作相关">链式操作相关</h2>

<h3 id="链式操作">链式操作</h3>

<p>Method Chaining，Gorm 实现了链式操作接口，所以你可以把代码写成这样：</p>

<pre><code class="language-go">// 创建一个查询
tx := db.Where(&quot;name = ?&quot;, &quot;jinzhu&quot;)

// 添加更多条件
if someCondition {
  tx = tx.Where(&quot;age = ?&quot;, 20)
} else {
  tx = tx.Where(&quot;age = ?&quot;, 30)
}

if yetAnotherCondition {
  tx = tx.Where(&quot;active = ?&quot;, 1)
}
</code></pre>

<p>在调用立即执行方法前不会生成<code>Query</code>语句，借助这个特性你可以创建一个函数来处理一些通用逻辑。</p>

<h3 id="立即执行方法">立即执行方法</h3>

<p>Immediate methods ，立即执行方法是指那些会立即生成<code>SQL</code>语句并发送到数据库的方法, 他们一般是<code>CRUD</code>方法，比如：</p>

<p><code>Create</code>, <code>First</code>, <code>Find</code>, <code>Take</code>, <code>Save</code>, <code>UpdateXXX</code>, <code>Delete</code>, <code>Scan</code>, <code>Row</code>, <code>Rows</code>…</p>

<p>这有一个基于上面链式方法代码的立即执行方法的例子：</p>

<pre><code class="language-go">tx.Find(&amp;user)
</code></pre>

<p>生成的SQL语句如下：</p>

<pre><code class="language-sql">SELECT * FROM users where name = 'jinzhu' AND age = 30 AND active = 1;
</code></pre>

<h3 id="范围">范围</h3>

<p><code>Scopes</code>，Scope是建立在链式操作的基础之上的。</p>

<p>基于它，你可以抽取一些通用逻辑，写出更多可重用的函数库。</p>

<pre><code class="language-go">func AmountGreaterThan1000(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;amount &gt; ?&quot;, 1000)
}

func PaidWithCreditCard(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;C&quot;)
}

func PaidWithCod(db *gorm.DB) *gorm.DB {
  return db.Where(&quot;pay_mode_sign = ?&quot;, &quot;C&quot;)
}

func OrderStatus(status []string) func (db *gorm.DB) *gorm.DB {
  return func (db *gorm.DB) *gorm.DB {
    return db.Scopes(AmountGreaterThan1000).Where(&quot;status IN (?)&quot;, status)
  }
}

db.Scopes(AmountGreaterThan1000, PaidWithCreditCard).Find(&amp;orders)
// 查找所有金额大于 1000 的信用卡订单

db.Scopes(AmountGreaterThan1000, PaidWithCod).Find(&amp;orders)
// 查找所有金额大于 1000 的 COD 订单

db.Scopes(AmountGreaterThan1000, OrderStatus([]string{&quot;paid&quot;, &quot;shipped&quot;})).Find(&amp;orders)
// 查找所有金额大于 1000 且已付款或者已发货的订单
</code></pre>

<h3 id="多个立即执行方法">多个立即执行方法</h3>

<p>Multiple Immediate Methods，在 GORM 中使用多个立即执行方法时，后一个立即执行方法会复用前一个<strong>立即执行方法</strong>的条件 (不包括内联条件) 。</p>

<pre><code class="language-go">db.Where(&quot;name LIKE ?&quot;, &quot;jinzhu%&quot;).Find(&amp;users, &quot;id IN (?)&quot;, []int{1, 2, 3}).Count(&amp;count)
</code></pre>

<p>生成的 Sql</p>

<pre><code class="language-sql">SELECT * FROM users WHERE name LIKE 'jinzhu%' AND id IN (1, 2, 3)

SELECT count(*) FROM users WHERE name LIKE 'jinzhu%'
</code></pre>

<h2 id="更新">更新</h2>

<h3 id="更新所有字段">更新所有字段</h3>

<p><code>Save()</code>默认会更新该对象的所有字段，即使你没有赋值。</p>

<pre><code class="language-go">db.First(&amp;user)

user.Name = &quot;七米&quot;
user.Age = 99
db.Save(&amp;user)

////  UPDATE `users` SET `created_at` = '2020-02-16 12:52:20', `updated_at` = '2020-02-16 12:54:55', `deleted_at` = NULL, `name` = '七米', `age` = 99, `active` = true  WHERE `users`.`deleted_at` IS NULL AND `users`.`id` = 1
</code></pre>

<h3 id="更新修改字段">更新修改字段</h3>

<p>如果你只希望更新指定字段，可以使用<code>Update</code>或者<code>Updates</code></p>

<pre><code class="language-go">// 更新单个属性，如果它有变化
db.Model(&amp;user).Update(&quot;name&quot;, &quot;hello&quot;)
//// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111;

// 根据给定的条件更新单个属性
db.Model(&amp;user).Where(&quot;active = ?&quot;, true).Update(&quot;name&quot;, &quot;hello&quot;)
//// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111 AND active=true;

// 使用 map 更新多个属性，只会更新其中有变化的属性
db.Model(&amp;user).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
//// UPDATE users SET name='hello', age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;

// 使用 struct 更新多个属性，只会更新其中有变化且为非零值的字段
db.Model(&amp;user).Updates(User{Name: &quot;hello&quot;, Age: 18})
//// UPDATE users SET name='hello', age=18, updated_at = '2013-11-17 21:34:10' WHERE id = 111;

// 警告：当使用 struct 更新时，GORM只会更新那些非零值的字段
// 对于下面的操作，不会发生任何更新，&quot;&quot;, 0, false 都是其类型的零值
db.Model(&amp;user).Updates(User{Name: &quot;&quot;, Age: 0, Active: false})
</code></pre>

<h3 id="更新选定字段">更新选定字段</h3>

<p>如果你想更新或忽略某些字段，你可以使用 <code>Select</code>，<code>Omit</code></p>

<pre><code class="language-go">db.Model(&amp;user).Select(&quot;name&quot;).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
//// UPDATE users SET name='hello', updated_at='2013-11-17 21:34:10' WHERE id=111;

db.Model(&amp;user).Omit(&quot;name&quot;).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18, &quot;active&quot;: false})
//// UPDATE users SET age=18, active=false, updated_at='2013-11-17 21:34:10' WHERE id=111;
</code></pre>

<h3 id="无hooks更新">无Hooks更新</h3>

<p>上面的更新操作会自动运行 model 的 <code>BeforeUpdate</code>, <code>AfterUpdate</code> 方法，更新 <code>UpdatedAt</code> 时间戳, 在更新时保存其 <code>Associations</code>, 如果你不想调用这些方法，你可以使用 <code>UpdateColumn</code>， <code>UpdateColumns</code></p>

<pre><code class="language-go">// 更新单个属性，类似于 `Update`
db.Model(&amp;user).UpdateColumn(&quot;name&quot;, &quot;hello&quot;)
//// UPDATE users SET name='hello' WHERE id = 111;

// 更新多个属性，类似于 `Updates`
db.Model(&amp;user).UpdateColumns(User{Name: &quot;hello&quot;, Age: 18})
//// UPDATE users SET name='hello', age=18 WHERE id = 111;
</code></pre>

<h3 id="批量更新">批量更新</h3>

<p>批量更新时<code>Hooks（钩子函数）</code>不会运行。</p>

<pre><code class="language-go">db.Table(&quot;users&quot;).Where(&quot;id IN (?)&quot;, []int{10, 11}).Updates(map[string]interface{}{&quot;name&quot;: &quot;hello&quot;, &quot;age&quot;: 18})
//// UPDATE users SET name='hello', age=18 WHERE id IN (10, 11);

// 使用 struct 更新时，只会更新非零值字段，若想更新所有字段，请使用map[string]interface{}
db.Model(User{}).Updates(User{Name: &quot;hello&quot;, Age: 18})
//// UPDATE users SET name='hello', age=18;

// 使用 `RowsAffected` 获取更新记录总数
db.Model(User{}).Updates(User{Name: &quot;hello&quot;, Age: 18}).RowsAffected
</code></pre>

<h3 id="使用sql表达式更新">使用SQL表达式更新</h3>

<p>先查询表中的第一条数据保存至user变量。</p>

<pre><code class="language-go">var user User
db.First(&amp;user)
db.Model(&amp;user).Update(&quot;age&quot;, gorm.Expr(&quot;age * ? + ?&quot;, 2, 100))
//// UPDATE `users` SET `age` = age * 2 + 100, `updated_at` = '2020-02-16 13:10:20'  WHERE `users`.`id` = 1;

db.Model(&amp;user).Updates(map[string]interface{}{&quot;age&quot;: gorm.Expr(&quot;age * ? + ?&quot;, 2, 100)})
//// UPDATE &quot;users&quot; SET &quot;age&quot; = age * '2' + '100', &quot;updated_at&quot; = '2020-02-16 13:05:51' WHERE `users`.`id` = 1;

db.Model(&amp;user).UpdateColumn(&quot;age&quot;, gorm.Expr(&quot;age - ?&quot;, 1))
//// UPDATE &quot;users&quot; SET &quot;age&quot; = age - 1 WHERE &quot;id&quot; = '1';

db.Model(&amp;user).Where(&quot;age &gt; 10&quot;).UpdateColumn(&quot;age&quot;, gorm.Expr(&quot;age - ?&quot;, 1))
//// UPDATE &quot;users&quot; SET &quot;age&quot; = age - 1 WHERE &quot;id&quot; = '1' AND quantity &gt; 10;
</code></pre>

<h3 id="修改hooks中的值">修改Hooks中的值</h3>

<p>如果你想修改 <code>BeforeUpdate</code>, <code>BeforeSave</code> 等 Hooks 中更新的值，你可以使用 <code>scope.SetColumn</code>, 例如：</p>

<pre><code class="language-go">func (user *User) BeforeSave(scope *gorm.Scope) (err error) {
  if pw, err := bcrypt.GenerateFromPassword(user.Password, 0); err == nil {
    scope.SetColumn(&quot;EncryptedPassword&quot;, pw)
  }
}
</code></pre>

<h3 id="其它更新选项">其它更新选项</h3>

<pre><code class="language-go">// 为 update SQL 添加其它的 SQL
db.Model(&amp;user).Set(&quot;gorm:update_option&quot;, &quot;OPTION (OPTIMIZE FOR UNKNOWN)&quot;).Update(&quot;name&quot;, &quot;hello&quot;)
//// UPDATE users SET name='hello', updated_at = '2013-11-17 21:34:10' WHERE id=111 OPTION (OPTIMIZE FOR UNKNOWN);
</code></pre>

<h2 id="删除">删除</h2>

<h3 id="删除记录">删除记录</h3>

<p><strong>警告</strong> 删除记录时，请确保主键字段有值，GORM 会通过主键去删除记录，如果主键为空，GORM 会删除该 model 的所有记录。</p>

<pre><code class="language-go">// 删除现有记录
db.Delete(&amp;email)
//// DELETE from emails where id=10;

// 为删除 SQL 添加额外的 SQL 操作
db.Set(&quot;gorm:delete_option&quot;, &quot;OPTION (OPTIMIZE FOR UNKNOWN)&quot;).Delete(&amp;email)
//// DELETE from emails where id=10 OPTION (OPTIMIZE FOR UNKNOWN);
</code></pre>

<h3 id="批量删除">批量删除</h3>

<p>删除全部匹配的记录</p>

<pre><code class="language-go">db.Where(&quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;).Delete(Email{})
//// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;

db.Delete(Email{}, &quot;email LIKE ?&quot;, &quot;%jinzhu%&quot;)
//// DELETE from emails where email LIKE &quot;%jinzhu%&quot;;
</code></pre>

<h3 id="软删除">软删除</h3>

<p>如果一个 model 有 <code>DeletedAt</code> 字段，他将自动获得软删除的功能！ 当调用 <code>Delete</code> 方法时， 记录不会真正的从数据库中被删除， 只会将<code>DeletedAt</code> 字段的值会被设置为当前时间</p>

<pre><code class="language-go">db.Delete(&amp;user)
//// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE id = 111;

// 批量删除
db.Where(&quot;age = ?&quot;, 20).Delete(&amp;User{})
//// UPDATE users SET deleted_at=&quot;2013-10-29 10:23&quot; WHERE age = 20;

// 查询记录时会忽略被软删除的记录
db.Where(&quot;age = 20&quot;).Find(&amp;user)
//// SELECT * FROM users WHERE age = 20 AND deleted_at IS NULL;

// Unscoped 方法可以查询被软删除的记录
db.Unscoped().Where(&quot;age = 20&quot;).Find(&amp;users)
//// SELECT * FROM users WHERE age = 20;
</code></pre>

<h3 id="物理删除">物理删除</h3>

<pre><code class="language-go">// Unscoped 方法可以物理删除记录
db.Unscoped().Delete(&amp;order)
//// DELETE FROM orders WHERE id=10;
</code></pre>

    </div>
    <div class="article-footer">
<blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接: </strong>
      <a href="https://mumulx.gitee.io/2022/10/gorm/" title="GORM" target="_blank" rel="external">https://mumulx.gitee.io/2022/10/gorm/</a>
    </li>
    <li class="post-copyright-license">
      <strong>License：</strong><a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN</a>
    </li>
  </ul>
</blockquote>

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://gitee.com/mumulx" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="https://mumulx.gitee.io/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://gitee.com/mumulx" target="_blank"><span class="text-dark">木木就是两个木</span><small class="ml-1x">木木</small></a></h3>
        <div>愿生活不太拥挤，愿笑容不必刻意。</div>
      </div>
    </figure>
  </div>
</div>
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://mumulx.gitee.io/2022/10/golang/" title="Golang"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;下一篇</span></a>
            </li>
            <li class="next">
                <a href="https://mumulx.gitee.io/2022/10/gin/"
                    title="Gin"><span>上一篇&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="文章目录" role="button">
                    <span>[&nbsp;</span><span>文章目录</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        
        <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal"
            data-target="#donateModal"><span>赏</span></button>
        
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>


<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content donate">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <div class="modal-body">
                <div class="donate-box">
                    <div class="donate-head">
                        <p>感谢您的支持,我会继续努力的!</p>
                    </div>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane fade active in" id="alipay">
                            <div class="donate-payimg">
                                <img src="https://mumulx.gitee.io/donate/alipayimg.png"
                                    alt="扫码支持" title="扫一扫" />
                            </div>
                            <p class="text-muted mv">扫码打赏, 多少你说了算~</p>
                            <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦~</p>
                        </div>
                        <div role="tabpanel" class="tab-pane fade" id="wechatpay">
                            <div class="donate-payimg">
                                <img src="https://mumulx.gitee.io/donate/wechatpayimg.png"
                                    alt="扫码支持" title="扫一扫" />
                            </div>
                            <p class="text-muted mv">扫码打赏, 多少你说了算~</p>
                            <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
                        </div>
                    </div>
                    <div class="donate-footer">
                        <ul class="nav nav-tabs nav-justified" role="tablist">
                            <li role="presentation" class="active">
                                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay"
                                    aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
                            </li>
                            <li role="presentation" class="">
                                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab"
                                    aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i>
                                    微信支付</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</main><footer class="footer" itemscope itemtype="https://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/mumulx" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://mumulx.gitee.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
    <li><a href="https://weibo.com/u/5459389722" target="_blank" title="weibo" data-toggle=tooltip data-placement=top >
            <i class="icon icon-weibo"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2019  -
    2022
    <div class="publishby">
        联系邮箱：<a target="_blank" title="木木的邮箱"> 1819778796@qq.com </a>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
   window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/rust.min.js"></script>
<script type="text/javascript"
   src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script>
hljs.configure({
  tabReplace: '    ', 
  classPrefix: ''     
                      
})
hljs.initHighlightingOnLoad();
</script>
<script type="text/javascript" src="https://mumulx.gitee.io/js/application.js"></script>
<script type="text/javascript" src="https://mumulx.gitee.io/js/plugin.js"></script>
<script>
      (function (window) {
          var INSIGHT_CONFIG = {
              TRANSLATION: {
                  POSTS: '文章',
                  PAGES: '页面',
                  CATEGORIES: '分类',
                  TAGS: '标签',
                  UNTITLED: '(未命名)',
              },
              ROOT_URL: 'https:\/\/mumulx.gitee.io\/',
              CONTENT_URL: 'https:\/\/mumulx.gitee.io\/\/searchindex.json ',
          };
          window.INSIGHT_CONFIG = INSIGHT_CONFIG;
      })(window);
      </script>
<script type="text/javascript" src="https://mumulx.gitee.io/js/insight.js"></script>

<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '1ccf8dc9e86b3575cfb2',
        clientSecret: '048ae422c4a6207a4e89c58ba1d4ebf820136bb0',
        repo: 'gittalk',
        owner: 'mumulx',
        admin: ['mumulx'],
        id: md5(location.pathname),
        distractionFreeMode: true
    });
    gitalk.render('comments');
</script>

  </body>
</html>
